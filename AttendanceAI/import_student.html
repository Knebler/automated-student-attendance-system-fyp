<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Import System - MySQL</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        h1 {
            color: #333;
            font-size: 32px;
        }

        .server-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .server-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .server-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.online {
            background: #28a745;
        }

        .status-dot.offline {
            background: #dc3545;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
            flex-wrap: wrap;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 15px;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input[type="text"],
        input[type="email"],
        input[type="time"],
        input[type="date"],
        input[type="number"],
        input[type="file"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn:hover:not(:disabled) {
            background: #5568d3;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover:not(:disabled) {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c82333;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
        }

        #preview {
            width: 100%;
            height: 280px;
            border-radius: 10px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            border: 2px dashed #ddd;
            overflow: hidden;
        }

        #preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.info {
            background: #cce5ff;
            color: #004085;
            border: 1px solid #99caff;
        }

        .note {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            color: #856404;
            font-size: 14px;
        }

        .summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }

        .summary h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .pending-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .pending-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .pending-item .name {
            font-weight: 600;
        }

        .pending-item .details {
            font-size: 12px;
            color: #666;
        }

        .pending-item .btn-remove {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .upload-progress {
            margin-top: 20px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 8px;
            display: none;
        }

        .progress-bar {
            height: 20px;
            background: #dee2e6;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üéì Complete Import System</h1>
                <p style="color: #666; margin-top: 10px;">Import Students, Lecturers, Courses, Venues, Timetable Slots & Sessions</p>
            </div>
            <div class="server-status disconnected" id="serverStatus">
                <span class="status-dot offline"></span>
                <span>Connecting...</span>
            </div>
        </div>

        <div id="alert" class="alert"></div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('students')">üë®‚Äçüéì Students</button>
            <button class="tab" onclick="switchTab('lecturers')">üë®‚Äçüè´ Lecturers</button>
            <button class="tab" onclick="switchTab('courses')">üìö Courses</button>
            <button class="tab" onclick="switchTab('venues')">üè¢ Venues</button>
            <button class="tab" onclick="switchTab('slots')">‚è∞ Time Slots</button>
            <button class="tab" onclick="switchTab('sessions')">üìÖ Sessions</button>
            <button class="tab" onclick="switchTab('summary')">üìä Summary</button>
        </div>

        <!-- Students Tab -->
        <div id="students-tab" class="tab-content active">
            <h2>Import Students with Facial Data</h2>
            <div class="form-grid">
                <div>
                    <div class="form-group">
                        <label>Student Name *</label>
                        <input type="text" id="studentName" placeholder="e.g., Chong Ye Han">
                    </div>
                    <div class="form-group">
                        <label>Student Email *</label>
                        <input type="email" id="studentEmail" placeholder="student@example.com">
                    </div>
                    <div class="form-group">
                        <label>Student Photo *</label>
                        <input type="file" id="studentPhoto" accept="image/*">
                    </div>
                    <div class="form-group">
                        <label>Training Samples</label>
                        <input type="number" id="sampleCount" value="100" min="10" max="200">
                    </div>
                    <button class="btn" onclick="addStudent()">Add Student to Queue</button>
                </div>
                <div>
                    <h3>Photo Preview</h3>
                    <div id="preview"><span>No photo selected</span></div>
                    <div class="pending-list" id="studentsList"></div>
                </div>
            </div>
        </div>

        <!-- Lecturers Tab -->
        <div id="lecturers-tab" class="tab-content">
            <h2>Import Lecturers</h2>
            <div class="form-grid">
                <div>
                    <div class="form-group">
                        <label>Lecturer Name *</label>
                        <input type="text" id="lecturerName" placeholder="e.g., Mr Lim">
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="lecturerEmail" placeholder="lecturer@example.com">
                    </div>
                    <div class="form-group">
                        <label>Department</label>
                        <input type="text" id="lecturerDept" placeholder="e.g., Computer Science">
                    </div>
                    <button class="btn" onclick="addLecturer()">Add Lecturer to Queue</button>
                </div>
                <div>
                    <h3>Pending Lecturers</h3>
                    <div class="pending-list" id="lecturersList"></div>
                </div>
            </div>
        </div>

        <!-- Courses Tab -->
        <div id="courses-tab" class="tab-content">
            <h2>Import Courses</h2>
            <div class="form-grid">
                <div>
                    <div class="form-group">
                        <label>Course Code *</label>
                        <input type="text" id="courseCode" placeholder="e.g., CS101">
                    </div>
                    <div class="form-group">
                        <label>Course Name *</label>
                        <input type="text" id="courseName" placeholder="e.g., Introduction to Programming">
                    </div>
                    <div class="form-group">
                        <label>Start Date *</label>
                        <input type="date" id="courseStart">
                    </div>
                    <div class="form-group">
                        <label>End Date *</label>
                        <input type="date" id="courseEnd">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="courseDesc" placeholder="Course description..."></textarea>
                    </div>
                    <button class="btn" onclick="addCourse()">Add Course to Queue</button>
                </div>
                <div>
                    <h3>Pending Courses</h3>
                    <div class="pending-list" id="coursesList"></div>
                </div>
            </div>
        </div>

        <!-- Venues Tab -->
        <div id="venues-tab" class="tab-content">
            <h2>Import Venues</h2>
            <div class="form-grid">
                <div>
                    <div class="form-group">
                        <label>Venue Name *</label>
                        <input type="text" id="venueName" placeholder="e.g., BLK A1.17">
                    </div>
                    <div class="form-group">
                        <label>Building</label>
                        <input type="text" id="venueBuilding" placeholder="e.g., Block A">
                    </div>
                    <div class="form-group">
                        <label>Capacity</label>
                        <input type="number" id="venueCapacity" placeholder="50">
                    </div>
                    <button class="btn" onclick="addVenue()">Add Venue to Queue</button>
                </div>
                <div>
                    <h3>Pending Venues</h3>
                    <div class="pending-list" id="venuesList"></div>
                </div>
            </div>
        </div>

        <!-- Timetable Slots Tab -->
        <div id="slots-tab" class="tab-content">
            <h2>Create Timetable Slots</h2>
            <div class="note">
                <strong>‚ö†Ô∏è Important:</strong> Timetable slots define the time periods for classes. 
                Sessions are linked to these slots. Create slots before creating sessions.
            </div>
            <div class="form-grid" style="margin-top: 20px;">
                <div>
                    <div class="form-group">
                        <label>Day of Week *</label>
                        <select id="slotDay">
                            <option value="1">Sunday</option>
                            <option value="2">Monday</option>
                            <option value="3">Tuesday</option>
                            <option value="4">Wednesday</option>
                            <option value="5">Thursday</option>
                            <option value="6">Friday</option>
                            <option value="7">Saturday</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Start Time *</label>
                        <input type="time" id="slotStart" value="08:00">
                    </div>
                    <div class="form-group">
                        <label>End Time *</label>
                        <input type="time" id="slotEnd" value="10:00">
                    </div>
                    <div class="form-group">
                        <label>Slot Name (Optional)</label>
                        <input type="text" id="slotName" placeholder="e.g., Morning Session 1">
                    </div>
                    <button class="btn" onclick="addSlot()">Add Time Slot to Queue</button>
                </div>
                <div>
                    <h3>Pending Time Slots</h3>
                    <div class="pending-list" id="slotsList"></div>
                </div>
            </div>
        </div>

        <!-- Sessions Tab -->
        <div id="sessions-tab" class="tab-content">
            <h2>Create Class Sessions</h2>
            <div class="note">
                <strong>‚ö†Ô∏è Important:</strong> You must upload Courses, Lecturers, Venues, and Time Slots first 
                before creating sessions. Click "Upload All" in the Summary tab first if you have pending items.
            </div>
            <div class="form-grid" style="margin-top: 20px;">
                <div>
                    <div class="form-group">
                        <label>Session Date *</label>
                        <input type="date" id="sessionDate">
                    </div>
                    <div class="form-group">
                        <label>Course * (from database)</label>
                        <select id="sessionCourse">
                            <option value="">Loading courses...</option>
                        </select>
                        <button class="btn btn-sm" onclick="refreshDropdowns()" style="margin-top: 5px;">üîÑ Refresh Lists</button>
                    </div>
                    <div class="form-group">
                        <label>Lecturer * (from database)</label>
                        <select id="sessionLecturer">
                            <option value="">Loading lecturers...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Venue * (from database)</label>
                        <select id="sessionVenue">
                            <option value="">Loading venues...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Time Slot * (from database)</label>
                        <select id="sessionSlot">
                            <option value="">Loading time slots...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Topic (Optional)</label>
                        <input type="text" id="sessionTopic" placeholder="e.g., Introduction to Algorithms">
                    </div>
                    <button class="btn" onclick="addSession()">Add Session to Queue</button>
                </div>
                <div>
                    <h3>Pending Sessions</h3>
                    <div class="pending-list" id="sessionsList"></div>
                </div>
            </div>
        </div>

        <!-- Summary Tab -->
        <div id="summary-tab" class="tab-content">
            <h2>Import Summary</h2>
            <div class="summary">
                <h3>Pending Upload</h3>
                <div class="summary-item">
                    <span>üë®‚Äçüéì Students:</span>
                    <span class="badge badge-warning" id="studentsCount">0</span>
                </div>
                <div class="summary-item">
                    <span>üë®‚Äçüè´ Lecturers:</span>
                    <span class="badge badge-warning" id="lecturersCount">0</span>
                </div>
                <div class="summary-item">
                    <span>üìö Courses:</span>
                    <span class="badge badge-warning" id="coursesCount">0</span>
                </div>
                <div class="summary-item">
                    <span>üè¢ Venues:</span>
                    <span class="badge badge-warning" id="venuesCount">0</span>
                </div>
                <div class="summary-item">
                    <span>‚è∞ Time Slots:</span>
                    <span class="badge badge-warning" id="slotsCount">0</span>
                </div>
                <div class="summary-item">
                    <span>üìÖ Sessions:</span>
                    <span class="badge badge-warning" id="sessionsCount">0</span>
                </div>
            </div>
            
            <div class="upload-progress" id="uploadProgress">
                <strong>Upload Progress</strong>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Preparing...</div>
            </div>

            <button class="btn btn-success" onclick="uploadAll()" style="margin-top: 20px;">
                üöÄ Upload All to Database
            </button>
            
            <button class="btn btn-danger" onclick="clearAll()" style="margin-top: 10px;">
                üóëÔ∏è Clear All Pending Data
            </button>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000';
        
        let pendingData = {
            students: [],
            lecturers: [],
            courses: [],
            venues: [],
            slots: [],
            sessions: []
        };

        // Database items (fetched from server)
        let dbData = {
            courses: [],
            lecturers: [],
            venues: [],
            slots: []
        };

        window.onload = function() {
            checkServerStatus();
            updateSummary();
            setDefaultDates();
            refreshDropdowns();
        };

        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('sessionDate').value = today;
            document.getElementById('courseStart').value = today;
            
            const endDate = new Date();
            endDate.setMonth(endDate.getMonth() + 6);
            document.getElementById('courseEnd').value = endDate.toISOString().split('T')[0];
            
            // Set default day of week to today
            const dayOfWeek = new Date().getDay() + 1; // MySQL uses 1-7 (Sunday=1)
            document.getElementById('slotDay').value = dayOfWeek;
        }

        // Photo preview
        document.getElementById('studentPhoto')?.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('preview').innerHTML = `<img src="${e.target.result}">`;
                };
                reader.readAsDataURL(file);
            }
        });

        async function checkServerStatus() {
            try {
                const response = await fetch(`${API_URL}/api/health`);
                const statusEl = document.getElementById('serverStatus');
                
                if (response.ok) {
                    const data = await response.json();
                    statusEl.className = 'server-status connected';
                    statusEl.innerHTML = `<span class="status-dot online"></span><span>Server Online (${data.database})</span>`;
                } else {
                    throw new Error('Server error');
                }
            } catch (error) {
                const statusEl = document.getElementById('serverStatus');
                statusEl.className = 'server-status disconnected';
                statusEl.innerHTML = '<span class="status-dot offline"></span><span>Server Offline</span>';
            }
        }

        async function refreshDropdowns() {
            showAlert('Refreshing data from database...', 'info');
            
            try {
                // Fetch courses
                try {
                    const coursesRes = await fetch(`${API_URL}/api/courses`);
                    const coursesText = await coursesRes.text();
                    try {
                        const coursesData = JSON.parse(coursesText);
                        if (coursesData.success) {
                            dbData.courses = coursesData.courses || [];
                        }
                    } catch (e) {
                        console.error('Courses API returned non-JSON:', coursesText.substring(0, 100));
                    }
                } catch (e) {
                    console.error('Failed to fetch courses:', e);
                }
                
                // Fetch lecturers
                try {
                    const lecturersRes = await fetch(`${API_URL}/api/lecturers`);
                    const lecturersText = await lecturersRes.text();
                    try {
                        const lecturersData = JSON.parse(lecturersText);
                        if (lecturersData.success) {
                            dbData.lecturers = lecturersData.lecturers || [];
                        }
                    } catch (e) {
                        console.error('Lecturers API returned non-JSON:', lecturersText.substring(0, 100));
                    }
                } catch (e) {
                    console.error('Failed to fetch lecturers:', e);
                }
                
                // Fetch venues
                try {
                    const venuesRes = await fetch(`${API_URL}/api/venues`);
                    const venuesText = await venuesRes.text();
                    try {
                        const venuesData = JSON.parse(venuesText);
                        if (venuesData.success) {
                            dbData.venues = venuesData.venues || [];
                        }
                    } catch (e) {
                        console.error('Venues API returned non-JSON:', venuesText.substring(0, 100));
                    }
                } catch (e) {
                    console.error('Failed to fetch venues:', e);
                }
                
                // Fetch slots
                try {
                    const slotsRes = await fetch(`${API_URL}/api/slots`);
                    const slotsText = await slotsRes.text();
                    try {
                        const slotsData = JSON.parse(slotsText);
                        if (slotsData.success) {
                            dbData.slots = slotsData.slots || [];
                        }
                    } catch (e) {
                        console.error('Slots API returned non-JSON:', slotsText.substring(0, 100));
                    }
                } catch (e) {
                    console.error('Failed to fetch slots:', e);
                }
                
                updateSessionDropdowns();
                showAlert(`Data refreshed! Courses: ${dbData.courses.length}, Lecturers: ${dbData.lecturers.length}, Venues: ${dbData.venues.length}, Slots: ${dbData.slots.length}`, 'success');
            } catch (error) {
                showAlert('Failed to refresh data: ' + error.message, 'error');
            }
        }

        function updateSessionDropdowns() {
            const courseSelect = document.getElementById('sessionCourse');
            const lecturerSelect = document.getElementById('sessionLecturer');
            const venueSelect = document.getElementById('sessionVenue');
            const slotSelect = document.getElementById('sessionSlot');
            
            // Update courses dropdown
            courseSelect.innerHTML = '<option value="">Select Course</option>' + 
                dbData.courses.map(c => `<option value="${c.course_id}">${c.course_code} - ${c.course_name}</option>`).join('');
            
            // Update lecturers dropdown
            lecturerSelect.innerHTML = '<option value="">Select Lecturer</option>' + 
                dbData.lecturers.map(l => `<option value="${l.lecturer_id}">${l.full_name} (${l.department || 'N/A'})</option>`).join('');
            
            // Update venues dropdown
            venueSelect.innerHTML = '<option value="">Select Venue</option>' + 
                dbData.venues.map(v => `<option value="${v.venue_id}">${v.venue_name} (${v.building || 'N/A'})</option>`).join('');
            
            // Update slots dropdown
            const days = ['', 'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            slotSelect.innerHTML = '<option value="">Select Time Slot</option>' + 
                dbData.slots.map(s => `<option value="${s.slot_id}">${days[s.day_of_week]} ${s.start_time}-${s.end_time} ${s.slot_name ? '(' + s.slot_name + ')' : ''}</option>`).join('');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Refresh dropdowns when switching to sessions tab
            if (tabName === 'sessions') {
                refreshDropdowns();
            }
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 4000);
        }

        function addStudent() {
            const name = document.getElementById('studentName').value.trim();
            const email = document.getElementById('studentEmail').value.trim();
            const photoInput = document.getElementById('studentPhoto');
            const sampleCount = parseInt(document.getElementById('sampleCount').value);
            
            if (!name || !email || !photoInput.files[0]) {
                showAlert('Please fill all student fields', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                pendingData.students.push({
                    name, email,
                    photo: e.target.result,
                    sample_count: sampleCount
                });
                
                document.getElementById('studentName').value = '';
                document.getElementById('studentEmail').value = '';
                document.getElementById('studentPhoto').value = '';
                document.getElementById('preview').innerHTML = '<span>No photo selected</span>';
                
                updateSummary();
                renderPendingList('students');
                showAlert(`Student ${name} added to queue`, 'success');
            };
            reader.readAsDataURL(photoInput.files[0]);
        }

        function addLecturer() {
            const name = document.getElementById('lecturerName').value.trim();
            const email = document.getElementById('lecturerEmail').value.trim();
            const dept = document.getElementById('lecturerDept').value.trim();
            
            if (!name || !email) {
                showAlert('Please fill required lecturer fields', 'error');
                return;
            }

            pendingData.lecturers.push({ name, email, department: dept });
            
            document.getElementById('lecturerName').value = '';
            document.getElementById('lecturerEmail').value = '';
            document.getElementById('lecturerDept').value = '';
            
            updateSummary();
            renderPendingList('lecturers');
            showAlert(`Lecturer ${name} added to queue`, 'success');
        }

        function addCourse() {
            const code = document.getElementById('courseCode').value.trim();
            const name = document.getElementById('courseName').value.trim();
            const start = document.getElementById('courseStart').value;
            const end = document.getElementById('courseEnd').value;
            const desc = document.getElementById('courseDesc').value.trim();
            
            if (!code || !name || !start || !end) {
                showAlert('Please fill required course fields', 'error');
                return;
            }

            pendingData.courses.push({ code, name, start_date: start, end_date: end, description: desc });
            
            document.getElementById('courseCode').value = '';
            document.getElementById('courseName').value = '';
            document.getElementById('courseDesc').value = '';
            
            updateSummary();
            renderPendingList('courses');
            showAlert(`Course ${code} added to queue`, 'success');
        }

        function addVenue() {
            const name = document.getElementById('venueName').value.trim();
            const building = document.getElementById('venueBuilding').value.trim();
            const capacity = document.getElementById('venueCapacity').value;
            
            if (!name) {
                showAlert('Please enter venue name', 'error');
                return;
            }

            pendingData.venues.push({ name, building, capacity: parseInt(capacity) || 50 });
            
            document.getElementById('venueName').value = '';
            document.getElementById('venueBuilding').value = '';
            document.getElementById('venueCapacity').value = '';
            
            updateSummary();
            renderPendingList('venues');
            showAlert(`Venue ${name} added to queue`, 'success');
        }

        function addSlot() {
            const day = parseInt(document.getElementById('slotDay').value);
            const start = document.getElementById('slotStart').value;
            const end = document.getElementById('slotEnd').value;
            const name = document.getElementById('slotName').value.trim();
            
            if (!start || !end) {
                showAlert('Please fill start and end times', 'error');
                return;
            }

            const days = ['', 'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            pendingData.slots.push({ 
                day_of_week: day, 
                day_name: days[day],
                start_time: start, 
                end_time: end, 
                slot_name: name 
            });
            
            document.getElementById('slotName').value = '';
            
            updateSummary();
            renderPendingList('slots');
            showAlert(`Time slot added to queue`, 'success');
        }

        function addSession() {
            const date = document.getElementById('sessionDate').value;
            const course_id = document.getElementById('sessionCourse').value;
            const lecturer_id = document.getElementById('sessionLecturer').value;
            const venue_id = document.getElementById('sessionVenue').value;
            const slot_id = document.getElementById('sessionSlot').value;
            const topic = document.getElementById('sessionTopic').value.trim();
            
            if (!date || !course_id || !lecturer_id || !venue_id || !slot_id) {
                showAlert('Please fill all required session fields. Make sure to upload courses, lecturers, venues, and slots first!', 'error');
                return;
            }

            // Get display names
            const course = dbData.courses.find(c => c.course_id == course_id);
            const lecturer = dbData.lecturers.find(l => l.lecturer_id == lecturer_id);
            const venue = dbData.venues.find(v => v.venue_id == venue_id);
            const slot = dbData.slots.find(s => s.slot_id == slot_id);

            pendingData.sessions.push({ 
                session_date: date, 
                course_id: parseInt(course_id),
                lecturer_id: parseInt(lecturer_id),
                venue_id: parseInt(venue_id),
                slot_id: parseInt(slot_id),
                session_topic: topic,
                // For display
                course_name: course ? course.course_code : 'Unknown',
                lecturer_name: lecturer ? lecturer.full_name : 'Unknown',
                venue_name: venue ? venue.venue_name : 'Unknown',
                slot_time: slot ? `${slot.start_time}-${slot.end_time}` : 'Unknown'
            });
            
            document.getElementById('sessionTopic').value = '';
            
            updateSummary();
            renderPendingList('sessions');
            showAlert('Session added to queue', 'success');
        }

        function removeItem(type, index) {
            pendingData[type].splice(index, 1);
            updateSummary();
            renderPendingList(type);
        }

        function renderPendingList(type) {
            const listEl = document.getElementById(`${type}List`);
            if (!listEl) return;
            
            const items = pendingData[type];
            
            if (items.length === 0) {
                listEl.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No items in queue</p>';
                return;
            }
            
            let html = '';
            items.forEach((item, index) => {
                let displayName = '';
                let details = '';
                
                switch(type) {
                    case 'students':
                        displayName = item.name;
                        details = `${item.email} | ${item.sample_count} samples`;
                        break;
                    case 'lecturers':
                        displayName = item.name;
                        details = `${item.email} | ${item.department || 'No dept'}`;
                        break;
                    case 'courses':
                        displayName = item.code;
                        details = item.name;
                        break;
                    case 'venues':
                        displayName = item.name;
                        details = `${item.building || 'N/A'} | Capacity: ${item.capacity}`;
                        break;
                    case 'slots':
                        displayName = `${item.day_name}`;
                        details = `${item.start_time} - ${item.end_time} ${item.slot_name ? '(' + item.slot_name + ')' : ''}`;
                        break;
                    case 'sessions':
                        displayName = item.session_date;
                        details = `${item.course_name} | ${item.lecturer_name} | ${item.venue_name}`;
                        break;
                }
                
                html += `
                    <div class="pending-item">
                        <div>
                            <div class="name">${displayName}</div>
                            <div class="details">${details}</div>
                        </div>
                        <button class="btn-remove" onclick="removeItem('${type}', ${index})">‚úï</button>
                    </div>
                `;
            });
            
            listEl.innerHTML = html;
        }

        function updateSummary() {
            document.getElementById('studentsCount').textContent = pendingData.students.length;
            document.getElementById('lecturersCount').textContent = pendingData.lecturers.length;
            document.getElementById('coursesCount').textContent = pendingData.courses.length;
            document.getElementById('venuesCount').textContent = pendingData.venues.length;
            document.getElementById('slotsCount').textContent = pendingData.slots.length;
            document.getElementById('sessionsCount').textContent = pendingData.sessions.length;
        }

        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = text;
        }

        async function uploadAll() {
            const totalItems = pendingData.students.length + pendingData.lecturers.length + 
                              pendingData.courses.length + pendingData.venues.length + 
                              pendingData.slots.length + pendingData.sessions.length;
            
            if (totalItems === 0) {
                showAlert('Nothing to upload!', 'error');
                return;
            }

            const progressEl = document.getElementById('uploadProgress');
            progressEl.style.display = 'block';
            updateProgress(0, 'Starting upload...');

            try {
                let currentProgress = 0;
                const progressStep = 100 / 6; // 6 types of data
                
                // 1. Upload Lecturers first (needed for sessions)
                if (pendingData.lecturers.length > 0) {
                    updateProgress(currentProgress, `Uploading ${pendingData.lecturers.length} lecturers...`);
                    try {
                        const res = await fetch(`${API_URL}/api/lecturers/import`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ lecturers: pendingData.lecturers, institution_id: 1 })
                        });
                        const data = await res.json();
                        if (!data.success) throw new Error(data.error || 'Failed to upload lecturers');
                        console.log('Lecturers uploaded:', data);
                        pendingData.lecturers = [];
                        renderPendingList('lecturers');
                    } catch (e) {
                        throw new Error('Lecturers upload failed: ' + e.message);
                    }
                }
                currentProgress += progressStep;
                
                // 2. Upload Courses (needed for sessions)
                if (pendingData.courses.length > 0) {
                    updateProgress(currentProgress, `Uploading ${pendingData.courses.length} courses...`);
                    try {
                        const res = await fetch(`${API_URL}/api/courses/import`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ courses: pendingData.courses, institution_id: 1 })
                        });
                        const data = await res.json();
                        if (!data.success) throw new Error(data.error || 'Failed to upload courses');
                        console.log('Courses uploaded:', data);
                        pendingData.courses = [];
                        renderPendingList('courses');
                    } catch (e) {
                        throw new Error('Courses upload failed: ' + e.message);
                    }
                }
                currentProgress += progressStep;
                
                // 3. Upload Venues (needed for sessions)
                if (pendingData.venues.length > 0) {
                    updateProgress(currentProgress, `Uploading ${pendingData.venues.length} venues...`);
                    try {
                        const res = await fetch(`${API_URL}/api/venues/import`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ venues: pendingData.venues, institution_id: 1 })
                        });
                        const data = await res.json();
                        if (!data.success) throw new Error(data.error || 'Failed to upload venues');
                        console.log('Venues uploaded:', data);
                        pendingData.venues = [];
                        renderPendingList('venues');
                    } catch (e) {
                        throw new Error('Venues upload failed: ' + e.message);
                    }
                }
                currentProgress += progressStep;
                
                // 4. Upload Time Slots (needed for sessions)
                if (pendingData.slots.length > 0) {
                    updateProgress(currentProgress, `Uploading ${pendingData.slots.length} time slots...`);
                    try {
                        const res = await fetch(`${API_URL}/api/slots/import`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ slots: pendingData.slots, institution_id: 1 })
                        });
                        const data = await res.json();
                        if (!data.success) throw new Error(data.error || 'Failed to upload time slots');
                        console.log('Slots uploaded:', data);
                        pendingData.slots = [];
                        renderPendingList('slots');
                    } catch (e) {
                        throw new Error('Time slots upload failed: ' + e.message);
                    }
                }
                currentProgress += progressStep;
                
                // 5. Upload Students (one at a time to avoid large payload)
                if (pendingData.students.length > 0) {
                    const totalStudents = pendingData.students.length;
                    for (let i = 0; i < totalStudents; i++) {
                        const student = pendingData.students[0]; // Always take first
                        updateProgress(currentProgress + (progressStep * i / totalStudents), 
                            `Uploading student ${i + 1}/${totalStudents}: ${student.name}...`);
                        try {
                            const res = await fetch(`${API_URL}/api/students/import`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ students: [student], institution_id: 1 })
                            });
                            const data = await res.json();
                            if (!data.success) throw new Error(data.error || `Failed to upload student ${student.name}`);
                            console.log(`Student ${student.name} uploaded:`, data);
                            pendingData.students.shift(); // Remove uploaded student
                            renderPendingList('students');
                        } catch (e) {
                            throw new Error(`Student "${student.name}" upload failed: ` + e.message);
                        }
                    }
                }
                currentProgress += progressStep;
                
                // 6. Upload Sessions (last, after all dependencies)
                if (pendingData.sessions.length > 0) {
                    updateProgress(currentProgress, `Creating ${pendingData.sessions.length} sessions...`);
                    try {
                        const res = await fetch(`${API_URL}/api/sessions/import`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ sessions: pendingData.sessions })
                        });
                        const data = await res.json();
                        if (!data.success) throw new Error(data.error || 'Failed to create sessions');
                        console.log('Sessions created:', data);
                        pendingData.sessions = [];
                        renderPendingList('sessions');
                    } catch (e) {
                        throw new Error('Sessions upload failed: ' + e.message);
                    }
                }
                
                updateProgress(100, 'All data uploaded successfully!');
                showAlert('‚úÖ All data uploaded successfully!', 'success');
                
                updateSummary();
                
                // Refresh dropdowns for sessions
                await refreshDropdowns();
                
                setTimeout(() => {
                    progressEl.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                console.error('Upload error:', error);
                updateProgress(0, `Error: ${error.message}`);
                showAlert(`Upload failed: ${error.message}`, 'error');
                updateSummary();
            }
        }

        function clearAll() {
            if (!confirm('Are you sure you want to clear all pending data?')) return;
            
            pendingData = {
                students: [],
                lecturers: [],
                courses: [],
                venues: [],
                slots: [],
                sessions: []
            };
            
            ['students', 'lecturers', 'courses', 'venues', 'slots', 'sessions'].forEach(type => {
                renderPendingList(type);
            });
            updateSummary();
            showAlert('All pending data cleared', 'success');
        }

        // Check server status every 10 seconds
        setInterval(checkServerStatus, 10000);
    </script>
</body>
</html>