{% extends "layouts/base.html" %}

{% block title %}Attendance Management - Class Details - AttendAI{% endblock %}

{% block content %}
<div class="dashboard-admin">
    <h1 class="page-title mb-4">Attendance Management - Class Details</h1>

    <!-- Class Card -->
    <div class="card-custom mb-4">
        <div class="card-header-custom">Class Details</div>
        <div class="card-body-custom">
            <div class="class-title-container mb-4">
                <h2 class="class-title">{{course_name}} - L{{class_id}}</h2>
                <div class="button-group">
                    <a href="{{ url_for('institution.audit_class_attendance', class_id=class_id) }}" class="btn-custom btn-audit">üîç Audit Attendance</a>
                    <a href="{{ url_for('institution.edit_class_form', course_id=course_id, class_id=class_id) }}" class="btn-custom btn-edit">Edit Class</a>
                </div>
            </div>
            
            <div class="class-info mb-4">
                <div class="info-group">
                    <span><strong>Date: </strong>{{ class.start_time }}</span>
                    <span><strong>Venue: </strong>{{ class.venue }}</span>
                </div>
                <div class="info-group">
                    <span><strong>Lecturer: </strong>{{ class.lecturer }}</span>
                    <span><strong>Status: </strong>
                        {% if class_status == 'completed' %}
                            <span class="status-badge completed">Completed</span>
                        {% elif class_status == 'in_progress' %}
                            <span class="status-badge ongoing">Ongoing</span>
                        {% elif class_status == 'cancelled' %}
                            <span class="status-badge cancelled">Cancelled</span>
                        {% else %}
                            <span class="status-badge upcoming">Upcoming</span>
                        {% endif %}
                    </span>
                </div>
                <div class="info-group">
                    <span><strong>Attendance Marked: </strong>{{ class.marked }} / {{ class.total }}</span>
                    <span><strong>Present: </strong>{{ class.present }}</span>
                </div>
                <div class="info-group">
                    <span><strong>Late: </strong>{{ class.late }}</span>
                    <span><strong>Absent: </strong>{{ class.absent }}</span>
                </div>
                <div class="info-group">
                    <span><strong>Excused: </strong>{{ class.excused }}</span>
                </div>
            </div>
            
            {% if class_status == 'cancelled' %}
            <div class="alert-cancelled mb-4">
                <strong>‚ö†Ô∏è This class has been cancelled.</strong> Attendance management is disabled for cancelled classes.
            </div>
            {% endif %}

            <div class="records-section">
                <h3 class="section-title mb-3">Records</h3>
                
                <!-- Search and Filter -->
                <div class="search-filter-container mb-4">
                    <div class="search-bar">
                        <input type="text" id="searchInput" class="search-input" placeholder="Search by name or ID">
                        <select id="statusFilter" class="filter-input">
                            <option value="">All Statuses</option>
                            <option value="present">Present</option>
                            <option value="absent">Absent</option>
                            <option value="late">Late</option>
                            <option value="excused">Excused</option>
                            <option value="unmarked">Unmarked</option>
                        </select>
                        <button id="clearSearch" class="btn-custom search-btn">Clear</button>
                    </div>
                </div>

                <!-- Records Table -->
                <div class="table-responsive">
                    <table class="records-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>ID</th>
                                <th>Attendance Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recordsTableBody">
                            {% for r in records %}
                            <tr class="row-{{ r.status }}" data-name="{{ r.student_name or r.student_id }}" data-id="{{ r.student_id }}" data-status="{{ r.status }}">
                                <td>{{ r.student_name or r.student_id }}</td>
                                <td>{{ r.student_id }}</td>
                                <td><span class="status-{{ r.status }}">{{ r.status|upper }}</span></td>
                                <td>
                                    <div class="action-buttons">
                                        {% if class_status != 'cancelled' %}
                                        <a href="{{ url_for('institution.student_class_attendance_details', course_id=course_id, class_id=class_id, student_id=r.get('student_id'))}}" class="btn-custom manage-btn">Manage</a>
                                        {% else %}
                                        <button class="btn-custom manage-btn-disabled" disabled>Manage</button>
                                        {% endif %}

                                        {% if r.get('notes') %}<span class="appeal-badge">Has Notes</span>{% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="pagination mt-4" id="paginationContainer">
                    <button id="prevPage" class="pagination-btn" disabled>
                        <span class="pagination-arrow">‚Äπ</span> Previous
                    </button>
                    <span id="pageInfo">Page 1 of 1</span>
                    <button id="nextPage" class="pagination-btn" disabled>
                        Next <span class="pagination-arrow">‚Ä∫</span>
                    </button>
                </div>
                <div class="results-count">
                    <span id="resultsCount">Showing {{ records|length }} of {{ records|length }} records</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Generate Report Button -->
    <div class="generate-container text-center mt-4">
        <button class="btn-custom generate-btn">Generate Class Reports</button>
    </div>
</div>

<style>
    /* Page Specific Styles */
    .dashboard-admin {
        max-width: 1400px;
        margin: 0 auto;
    }

    .page-title {
        font-size: 2.5rem;
        font-weight: bold;
        font-style: italic;
        color: var(--text-dark);
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 1rem;
    }

    /* Class Title Container */
    .class-title-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .button-group {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .class-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--text-dark);
        text-decoration: underline;
        margin: 0;
    }

    /* Button Styles */
    .btn-audit {
        padding: 0.75rem 1.75rem;
        border-radius: 25px;
        font-size: 0.9rem;
        font-weight: 500;
        background-color: #2563eb;
        color: white;
        border: none;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .btn-audit:hover {
        background-color: #1e40af;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .class-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--text-dark);
        text-decoration: underline;
        margin: 0;
    }

    /* Class Info */
    .class-info {
        background-color: var(--primary-light);
        border-radius: 10px;
        padding: 1.5rem;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        border: 1px solid var(--border-color);
    }

    .info-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .info-group span {
        font-size: 0.9rem;
        color: var(--text-dark);
    }

    .info-group strong {
        color: var(--primary-dark);
    }

    /* Status Badges */
    .status-badge {
        font-weight: 600;
        font-size: 0.85rem;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        display: inline-block;
    }

    .status-badge.completed {
        color: #059669;
        background-color: #f0fdf4;
        border: 1px solid #059669;
    }

    .status-badge.ongoing {
        color: #2563eb;
        background-color: #eff6ff;
        border: 1px solid #2563eb;
    }

    .status-badge.upcoming {
        color: #7c3aed;
        background-color: #faf5ff;
        border: 1px solid #7c3aed;
    }

    .status-badge.cancelled {
        color: #dc2626;
        background-color: #fef2f2;
        border: 1px solid #dc2626;
    }

    /* Alert for cancelled class */
    .alert-cancelled {
        background-color: #fef2f2;
        border: 2px solid #dc2626;
        border-radius: 10px;
        padding: 1rem 1.5rem;
        color: #dc2626;
        font-size: 0.95rem;
    }

    /* Section Title */
    .section-title {
        font-weight: 700;
        margin-bottom: 1rem;
        font-size: 1.25rem;
        color: var(--text-dark);
    }

    /* Search and Filter */
    .search-filter-container {
        background-color: var(--primary-light);
        border-radius: 10px;
        padding: 1rem;
        border: 1px solid var(--border-color);
    }

    .search-bar {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .search-input,
    .filter-input {
        flex: 1;
        max-width: 250px;
        padding: 0.75rem 1.25rem;
        border: 1px solid var(--border-color);
        border-radius: 25px;
        font-size: 0.9rem;
        background-color: white;
        cursor: pointer;
    }

    .filter-input:focus,
    .search-input:focus {
        outline: none;
        border-color: var(--primary-dark);
    }

    .search-btn {
        padding: 0.75rem 2rem;
        border-radius: 25px;
        font-size: 0.9rem;
    }

    /* Records Table */
    .table-responsive {
        overflow-x: auto;
    }

    .records-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }

    .records-table thead {
        background-color: var(--primary-dark);
        color: white;
    }

    .records-table th {
        padding: 1rem 1.25rem;
        text-align: center;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .records-table th:first-child {
        text-align: left;
        border-radius: 8px 0 0 8px;
    }

    .records-table th:last-child {
        border-radius: 0 8px 8px 0;
    }

    .records-table td {
        padding: 1rem 1.25rem;
        text-align: center;
        font-size: 0.9rem;
        border-bottom: 1px solid var(--border-color);
    }

    .records-table td:first-child {
        text-align: left;
    }

    /* Row colors based on status */
    .row-absent {
        background-color: #ffebee;
    }

    .row-vr {
        background-color: #e3f2fd;
    }

    .row-present {
        background-color: #e8f5e9;
    }

    /* Status text colors */
    .status-absent {
        color: #d32f2f;
        font-weight: bold;
    }

    .status-vr {
        color: #1976d2;
        font-weight: 500;
    }

    .status-present {
        color: #2e7d32;
        font-weight: bold;
    }

    /* Action buttons */
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
        align-items: center;
    }

    .manage-btn {
        padding: 0.5rem 1.25rem;
        border-radius: 20px;
        font-size: 0.8rem;
        background-color: var(--primary-dark);
        color: white;
        border: none;
        cursor: pointer;
    }

    .manage-btn:hover {
        background-color: #1e293b;
    }

    .manage-btn-disabled {
        padding: 0.5rem 1.25rem;
        border-radius: 20px;
        font-size: 0.8rem;
        background-color: #9ca3af;
        color: white;
        border: none;
        cursor: not-allowed;
        opacity: 0.6;
    }

    .btn-edit {
        padding: 0.75rem 1.75rem;
        border-radius: 25px;
        font-size: 0.9rem;
        font-weight: 500;
        background-color: #f59e0b;
        color: white;
        border: none;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .btn-edit:hover {
        background-color: #d97706;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .appeal-badge {
        background-color: #ff5252;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    /* Pagination */
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
        color: var(--text-dark);
    }

    .pagination span {
        font-size: 0.9rem;
    }

    .pagination-btn {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.9rem;
        background-color: var(--primary-dark);
        color: white;
        border: none;
        cursor: pointer;
        transition: background-color 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .pagination-btn:hover:not(:disabled) {
        background-color: #1e293b;
    }

    .pagination-btn:disabled {
        background-color: #9ca3af;
        cursor: not-allowed;
        opacity: 0.6;
    }

    .pagination-arrow {
        font-weight: bold;
        font-size: 1rem;
    }

    .results-count {
        text-align: center;
        margin-top: 1rem;
        font-size: 0.9rem;
        color: var(--text-dark);
    }

    /* Generate Button */
    .generate-container {
        margin-top: 2rem;
    }

    .generate-btn {
        padding: 1rem 4rem;
        border-radius: 30px;
        font-size: 1.25rem;
        font-weight: 500;
        background-color: var(--primary-dark);
        color: white;
        border: none;
        cursor: pointer;
    }

    .generate-btn:hover {
        background-color: #1e293b;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .class-info {
            grid-template-columns: repeat(2, 1fr);
        }

        .search-bar {
            flex-wrap: wrap;
        }

        .search-input,
        .filter-input {
            max-width: 100%;
        }
    }

    @media (max-width: 768px) {
        .page-title {
            font-size: 1.75rem;
        }

        .class-title-container {
            flex-direction: column;
            align-items: flex-start;
        }

        .class-info {
            grid-template-columns: 1fr;
        }

        .search-bar {
            flex-direction: column;
        }

        .records-table {
            font-size: 0.8rem;
        }

        .records-table th,
        .records-table td {
            padding: 0.75rem 0.5rem;
        }

        .action-buttons {
            flex-direction: column;
            gap: 0.5rem;
        }

        .generate-btn {
            padding: 0.75rem 2rem;
            font-size: 1rem;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get all table rows
    const tableBody = document.getElementById('recordsTableBody');
    const allRows = Array.from(tableBody.querySelectorAll('tr'));
    
    // Get filter elements
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const clearBtn = document.getElementById('clearSearch');
    const resultsCount = document.getElementById('resultsCount');
    const resultsCountContainer = resultsCount.parentElement;
    
    // Pagination elements
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    const pageInfo = document.getElementById('pageInfo');
    const paginationContainer = document.getElementById('paginationContainer');
    
    // Pagination settings
    const itemsPerPage = 10;
    let currentPage = 1;
    let filteredRows = [...allRows];
    
    // Filter function
    function applyFilters() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const statusValue = statusFilter.value.toLowerCase();
        
        filteredRows = allRows.filter(row => {
            const name = row.getAttribute('data-name').toLowerCase();
            const id = row.getAttribute('data-id').toLowerCase();
            const status = row.getAttribute('data-status').toLowerCase();
            
            // Check search term (name or ID)
            const matchesSearch = searchTerm === '' || 
                                name.includes(searchTerm) || 
                                id.includes(searchTerm);
            
            // Check status filter
            const matchesStatus = statusValue === '' || status === statusValue;
            
            return matchesSearch && matchesStatus;
        });
        
        // Reset to first page
        currentPage = 1;
        renderTable();
    }
    
    // Render table with pagination
    function renderTable() {
        // Remove any existing "no results" row first
        const existingNoResults = tableBody.querySelector('.no-results-row');
        if (existingNoResults) {
            existingNoResults.remove();
        }
        
        // Hide all rows first
        allRows.forEach(row => row.style.display = 'none');
        
        // Calculate pagination
        const totalPages = Math.ceil(filteredRows.length / itemsPerPage);
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const rowsToShow = filteredRows.slice(startIndex, endIndex);
        
        // Show filtered rows for current page
        rowsToShow.forEach(row => row.style.display = '');
        
        // Update results count
        const showingStart = filteredRows.length > 0 ? startIndex + 1 : 0;
        const showingEnd = Math.min(endIndex, filteredRows.length);
        resultsCount.textContent = `Showing ${showingStart}-${showingEnd} of ${filteredRows.length} records`;
        
        // Hide pagination and results count if less than 7 records
        if (filteredRows.length < 7) {
            paginationContainer.style.display = 'none';
            resultsCountContainer.style.display = 'none';
        } else {
            paginationContainer.style.display = 'flex';
            resultsCountContainer.style.display = 'block';
        }
        
        // Update pagination controls
        pageInfo.textContent = `Page ${currentPage} of ${totalPages || 1}`;
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage >= totalPages || totalPages === 0;
        
        // Show "no results" message if needed
        if (filteredRows.length === 0) {
            const noResultsRow = document.createElement('tr');
            noResultsRow.className = 'no-results-row';
            noResultsRow.innerHTML = '<td colspan="4" style="text-align: center; padding: 2rem; color: #6b7280;">No records found matching your search criteria.</td>';
            tableBody.appendChild(noResultsRow);
        }
    }
    
    // Clear filters
    function clearFilters() {
        searchInput.value = '';
        statusFilter.value = '';
        filteredRows = [...allRows];
        currentPage = 1;
        renderTable();
    }
    
    // Event listeners
    searchInput.addEventListener('input', applyFilters);
    statusFilter.addEventListener('change', applyFilters);
    clearBtn.addEventListener('click', clearFilters);
    
    prevPageBtn.addEventListener('click', function() {
        if (currentPage > 1) {
            currentPage--;
            renderTable();
        }
    });
    
    nextPageBtn.addEventListener('click', function() {
        const totalPages = Math.ceil(filteredRows.length / itemsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            renderTable();
        }
    });
    
    // Initial render
    renderTable();
});
</script>

{% endblock %}