{% extends "layouts/base.html" %} {% block title %}Attendance Management -
AttendAI{% endblock %} {% block content %}
<div class="attendance-management">
  <h1 class="page-title mb-4">Attendance Management</h1>

  <!-- Class Info Card -->
  <div class="class-info-card mb-4">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h2 class="class-code">
          {{ class.course_code }} - {{ class.section }}
        </h2>
        <div class="class-details">
          <span class="class-detail-item">
            <span class="detail-icon">üìÖ</span>
            {{ class.date }}
          </span>
          <span class="class-detail-item">
            <span class="detail-icon">üìç</span>
            {{ class.room }}
          </span>
          <span class="class-detail-item">
            <span class="detail-icon">üïê</span>
            {{ class.time }}
          </span>
        </div>
      </div>
      <div>
        <a
          href="{{ url_for('institution_lecturer.manage_classes', class_id=class.id) }}"
          class="btn-outline-custom"
          >Class Details</a
        >
      </div>
    </div>
  </div>

  <!-- Search and Filter Section -->
  <div class="search-section mb-4">
    <div
      class="d-flex flex-wrap gap-3 align-items-center justify-content-between"
    >
      <div class="d-flex flex-wrap gap-3">
        <div class="search-box">
          <input
            type="text"
            id="searchInput"
            placeholder="Search by name or ID..."
            onkeyup="AttendanceManager.searchStudents()"
          />
          <span class="search-icon">üîç</span>
        </div>

        <div class="filter-dropdown">
          <select
            id="statusFilter"
            class="filter-select"
            onchange="AttendanceManager.filterStudents()"
          >
            <option value="all">All Students</option>
            <option value="present">Present Only</option>
            <option value="absent">Absent Only</option>
            <option value="late">Late Only</option>
          </select>
        </div>

        <button class="btn-custom" onclick="AttendanceManager.refreshAttendance()">
          <span class="btn-icon">üîÑ</span>
          Refresh
        </button>
      </div>

      <div class="d-flex gap-3">
        <button class="btn-custom" id="faceRecognitionBtn" onclick="AttendanceManager.toggleFaceRecognition()">
          <span class="btn-icon">üì∏</span>
          <span id="faceRecognitionBtnText">Face Recognition</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Live Update Indicator -->
  <div id="liveUpdateIndicator" class="live-update-indicator mb-3">
    <span class="pulse-dot"></span>
    <span id="liveUpdateText">Live updates active - Polling every 2 seconds</span>
  </div>

  <!-- Debug Panel (can be hidden in production) -->
  <div id="debugPanel" class="debug-panel mb-3" style="display: none; background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 8px; font-family: monospace; font-size: 0.8rem;">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <strong>üîß Debug Panel</strong>
      <button onclick="document.getElementById('debugPanel').style.display='none'" style="background:none;border:none;color:#e2e8f0;cursor:pointer;">√ó</button>
    </div>
    <div id="debugOutput" style="max-height: 150px; overflow-y: auto;"></div>
  </div>

  <!-- Face Recognition Status -->
  <div
    id="faceRecognitionStatus"
    class="face-recognition-status mb-4"
    style="display: none"
  >
    <div class="card-custom">
      <div
        class="card-header-custom d-flex justify-content-between align-items-center"
      >
        <span>üé• Face Recognition Status</span>
        <button class="btn-close" onclick="AttendanceManager.hideFaceRecognitionPanel()">√ó</button>
      </div>
      <div class="card-body-custom">
        <!-- Camera Preview -->
        <div class="camera-preview-section mb-3">
          <video id="cameraPreview" autoplay playsinline style="width: 100%; max-width: 640px; border-radius: 8px; background: #000;"></video>
          <canvas id="captureCanvas" style="display: none;"></canvas>
        </div>
        
        <div class="face-recognition-info">
          <div class="face-stats">
            <div class="face-stat-item">
              <span class="face-stat-label">Status:</span>
              <span class="face-stat-value" id="recognitionStatus">Stopped</span>
            </div>
            <div class="face-stat-item">
              <span class="face-stat-label">Mode:</span>
              <span class="face-stat-value">Browser Camera</span>
            </div>
            <div class="face-stat-item">
              <span class="face-stat-label">Session:</span>
              <span class="face-stat-value" id="recognitionSession">{{ class.id }}</span>
            </div>
            <div class="face-stat-item">
              <span class="face-stat-label">Students Recognized:</span>
              <span class="face-stat-value" id="recognizedCount">0</span>
            </div>
            <div class="face-stat-item">
              <span class="face-stat-label">Frames Processed:</span>
              <span class="face-stat-value" id="framesProcessed">0</span>
            </div>
          </div>
          <div class="face-recognition-controls">
            <button class="btn-custom btn-success" id="startRecognitionBtn" onclick="AttendanceManager.startFaceRecognition()">
              <span class="btn-icon">‚ñ∂Ô∏è</span>
              Start Recognition
            </button>
            <button class="btn-outline-custom btn-danger" id="stopRecognitionBtn" onclick="AttendanceManager.stopFaceRecognition()" disabled>
              <span class="btn-icon">‚èπÔ∏è</span>
              Stop Camera
            </button>
            <button class="btn-outline-custom" onclick="AttendanceManager.checkRecognitionStatus()">
              <span class="btn-icon">üìä</span>
              View Stats
            </button>
            <button class="btn-outline-custom" onclick="AttendanceManager.toggleDebug()">
              <span class="btn-icon">üîß</span>
              Debug
            </button>
          </div>
        </div>
        
        <!-- Recognition Log -->
        <div class="recognition-log mt-3" id="recognitionLog">
          <h5>üìã Recognition Log</h5>
          <div class="log-container" id="logContainer" style="max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 8px; font-family: monospace; font-size: 0.85rem;">
            <div class="log-entry info">Waiting for updates...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Students Grid -->
  <div class="students-container">
    <div class="students-header mb-3">
      <h3>Student Roster</h3>
      <div class="attendance-summary">
        <span class="summary-item"
          >Total:
          <strong id="summaryTotal">{{ stats.total_students }}</strong></span
        >
        <span class="summary-item present"
          >Present:
          <strong id="summaryPresent"
            >{{ stats.present_students }}</strong
          ></span
        >
        <span class="summary-item absent"
          >Absent:
          <strong id="summaryAbsent">{{ stats.absent_students }}</strong></span
        >
        <span class="summary-item late"
          >Late:
          <strong id="summaryLate">{{ stats.late_students }}</strong></span
        >
      </div>
    </div>

    <div class="students-grid" id="studentsGrid">
      {% for student in students %}
      <div
        class="student-card card-custom {{ student.status | default('unmarked') }}"
        data-id="{{ student.id }}"
        data-user-id="{{ student.user_id | default(student.id) }}"
        data-student-id="{{ student.student_id | default(student.user_id) | default(student.id) }}"
        data-name="{{ student.name }}"
        data-status="{{ student.status | default('unmarked') }}"
      >
        <div class="student-header">
          <div class="student-photo">
            {% if student.photo_url %}
            <img src="{{ student.photo_url }}" alt="{{ student.name }}" />
            {% else %}
            <div class="student-photo-placeholder">{{ student.name[0] }}</div>
            {% endif %}
          </div>
          <div class="student-info">
            <h4 class="student-name">{{ student.name }}</h4>
            <p class="student-id">{{ student.id_number }}</p>
            <p class="student-email">{{ student.email }}</p>
          </div>
        </div>

        <div class="student-status">
          <span class="status-badge status-{{ student.status | default('unmarked') }}"
            >{{ student.status | default('Unmarked') }}</span
          >
          <span class="last-updated">{{ student.recorded_at | default('') }}</span>
        </div>

        <div class="attendance-controls">
          <div class="attendance-buttons">
            <button
              class="attendance-btn present {{ 'active' if student.status == 'present' }}"
              onclick="AttendanceManager.markAttendance('{{ student.id }}', 'present')"
              title="Mark as Present"
            >
              <span class="btn-icon">‚úì</span>
              Present
            </button>
            <button
              class="attendance-btn absent {{ 'active' if student.status == 'absent' }}"
              onclick="AttendanceManager.markAttendance('{{ student.id }}', 'absent')"
              title="Mark as Absent"
            >
              <span class="btn-icon">‚úï</span>
              Absent
            </button>
            <button
              class="attendance-btn late {{ 'active' if student.status == 'late' }}"
              onclick="AttendanceManager.markAttendance('{{ student.id }}', 'late')"
              title="Mark as Late"
            >
              <span class="btn-icon">üïê</span>
              Late
            </button>
          </div>

          <div class="attendance-notes">
            <input
              type="text"
              class="notes-input"
              placeholder="Add note..."
              value="{{ '' if student.notes and student.notes.startswith('{') else (student.notes | default('')) }}"
              oninput="AttendanceManager.saveNote('{{ student.id }}', this.value)"
            />
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    {% if not students %}
    <div class="empty-state card-custom">
      <div class="empty-state-content">
        <div class="empty-state-icon">üë•</div>
        <h4>No Students Found</h4>
        <p>This class doesn't have any students enrolled yet.</p>
        <a
          href="{{ url_for('institution_lecturer.manage_classes') }}"
          class="btn-custom"
          >Manage Roster</a
        >
      </div>
    </div>
    {% endif %}
  </div>
</div>

<style>
  .attendance-management {
    max-width: 1400px;
    margin: 0 auto;
  }

  .page-title {
    font-size: 2.5rem;
    font-weight: bold;
    font-style: italic;
    color: var(--text-dark);
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 1rem;
  }

  .live-update-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background-color: #f0fdf4;
    border: 1px solid #059669;
    border-radius: 8px;
    padding: 0.75rem 1rem;
    color: #059669;
    font-size: 0.9rem;
    font-weight: 500;
  }

  .pulse-dot {
    width: 10px;
    height: 10px;
    background-color: #059669;
    border-radius: 50%;
    animation: pulse-animation 1.5s infinite;
  }

  @keyframes pulse-animation {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.7; }
    100% { transform: scale(1); opacity: 1; }
  }

  .class-info-card {
    background-color: var(--primary-dark);
    color: white;
    border-radius: 15px;
    padding: 1.5rem 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .class-code {
    font-size: 1.75rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
  }

  .class-details {
    display: flex;
    gap: 2rem;
    flex-wrap: wrap;
  }

  .class-detail-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
  }

  .detail-icon {
    font-size: 1.25rem;
  }

  .search-section {
    background-color: var(--primary-light);
    border-radius: 15px;
    padding: 1.5rem;
    border: 2px solid var(--border-color);
  }

  .search-box {
    position: relative;
    flex: 1;
    max-width: 400px;
  }

  .search-box input {
    width: 100%;
    padding: 0.875rem 1rem 0.875rem 3rem;
    border: 2px solid var(--border-color);
    border-radius: 50px;
    background-color: white;
    font-size: 0.9rem;
    color: var(--text-dark);
  }

  .search-box input:focus {
    outline: none;
    border-color: var(--primary-dark);
  }

  .search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-light);
  }

  .filter-select {
    padding: 0.875rem 3rem;
    border: 2px solid var(--border-color);
    border-radius: 50px;
    background-color: white;
    font-size: 0.9rem;
    color: var(--text-dark);
    min-width: 180px;
  }

  .btn-icon {
    margin-right: 0.5rem;
  }

  .btn-success {
    background-color: #059669 !important;
    border-color: #059669 !important;
    color: white !important;
  }

  .btn-success:hover {
    background-color: #047857 !important;
    border-color: #047857 !important;
  }

  .btn-danger {
    color: #dc2626 !important;
    border-color: #dc2626 !important;
  }

  .btn-danger:hover {
    background-color: #dc2626 !important;
    color: white !important;
  }

  .btn-recognition-running {
    background-color: #059669 !important;
    border-color: #059669 !important;
    color: white !important;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(5, 150, 105, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(5, 150, 105, 0); }
    100% { box-shadow: 0 0 0 0 rgba(5, 150, 105, 0); }
  }

  .face-recognition-status {
    animation: slideDown 0.3s ease;
  }

  .camera-preview-section {
    text-align: center;
    background: #1e293b;
    padding: 1rem;
    border-radius: 8px;
  }

  .camera-preview-section video {
    max-height: 400px;
    border: 2px solid #059669;
  }

  .face-recognition-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 2rem;
  }

  .face-stats {
    display: flex;
    gap: 2rem;
    flex-wrap: wrap;
  }

  .face-stat-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .face-stat-label {
    font-size: 0.85rem;
    color: var(--text-light);
  }

  .face-stat-value {
    font-size: 1.25rem;
    font-weight: bold;
    color: var(--text-dark);
  }

  .face-stat-value.status-running {
    color: #059669;
  }

  .face-stat-value.status-stopped {
    color: #dc2626;
  }

  .face-recognition-controls {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .recognition-log h5 {
    margin-bottom: 0.5rem;
    color: var(--text-dark);
  }

  .log-entry {
    padding: 4px 0;
    border-bottom: 1px solid #e2e8f0;
  }

  .log-entry:last-child {
    border-bottom: none;
  }

  .log-entry.success {
    color: #059669;
  }

  .log-entry.error {
    color: #dc2626;
  }

  .log-entry.info {
    color: #0891b2;
  }

  .log-entry.warn {
    color: #d97706;
  }

  .students-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .students-header h3 {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--text-dark);
    margin: 0;
  }

  .attendance-summary {
    display: flex;
    gap: 1.5rem;
  }

  .summary-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
  }

  .summary-item.present {
    color: #059669;
  }

  .summary-item.absent {
    color: #dc2626;
  }

  .summary-item.late {
    color: #d97706;
  }

  .summary-item strong {
    font-size: 1.1rem;
  }

  .students-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
  }

  .student-card {
    padding: 1.5rem;
    transition: all 0.3s ease;
    border-left: 4px solid #9ca3af;
  }

  .student-card.present {
    border-left: 4px solid #059669;
  }

  .student-card.absent {
    border-left: 4px solid #dc2626;
  }

  .student-card.late {
    border-left: 4px solid #d97706;
  }

  .student-card.just-updated {
    animation: highlight-update 2s ease;
  }

  @keyframes highlight-update {
    0% { background-color: #d1fae5; transform: scale(1.02); }
    100% { background-color: white; transform: scale(1); }
  }

  .student-header {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .student-photo {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    overflow: hidden;
    border: 2px solid var(--border-color);
  }

  .student-photo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .student-photo-placeholder {
    width: 100%;
    height: 100%;
    background-color: var(--primary-light);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    font-weight: bold;
    color: var(--primary-dark);
    text-transform: uppercase;
  }

  .student-info h4 {
    font-size: 1.1rem;
    font-weight: bold;
    color: var(--text-dark);
    margin-bottom: 0.25rem;
  }

  .student-id {
    font-size: 0.85rem;
    color: var(--primary-dark);
    font-weight: 600;
    margin-bottom: 0.125rem;
  }

  .student-email {
    font-size: 0.8rem;
    color: var(--text-light);
  }

  .student-status {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid #e2e8f0;
  }

  .status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 50px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: capitalize;
  }

  .status-present {
    background-color: #f0fdf4;
    color: #059669;
    border: 1px solid #059669;
  }

  .status-absent {
    background-color: #fef2f2;
    color: #dc2626;
    border: 1px solid #dc2626;
  }

  .status-late {
    background-color: #fffbeb;
    color: #d97706;
    border: 1px solid #d97706;
  }

  .status-pending, .status-unmarked {
    background-color: #f3f4f6;
    color: #6b7280;
    border: 1px solid #9ca3af;
  }

  .last-updated {
    font-size: 0.75rem;
    color: var(--text-light);
  }

  .attendance-controls {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .attendance-buttons {
    display: flex;
    gap: 0.5rem;
  }

  .attendance-btn {
    flex: 1;
    padding: 0.5rem;
    border: 2px solid;
    border-radius: 8px;
    background-color: transparent;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
    transition: all 0.2s ease;
  }

  .attendance-btn.present {
    color: #059669;
    border-color: #059669;
  }

  .attendance-btn.present:hover,
  .attendance-btn.present.active {
    background-color: #059669;
    color: white;
  }

  .attendance-btn.absent {
    color: #dc2626;
    border-color: #dc2626;
  }

  .attendance-btn.absent:hover,
  .attendance-btn.absent.active {
    background-color: #dc2626;
    color: white;
  }

  .attendance-btn.late {
    color: #d97706;
    border-color: #d97706;
  }

  .attendance-btn.late:hover,
  .attendance-btn.late.active {
    background-color: #d97706;
    color: white;
  }

  .attendance-notes {
    width: 100%;
  }

  .notes-input {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-size: 0.85rem;
    color: var(--text-dark);
  }

  .notes-input:focus {
    outline: none;
    border-color: var(--primary-dark);
  }

  .empty-state {
    text-align: center;
    padding: 3rem;
  }

  .empty-state-content {
    max-width: 400px;
    margin: 0 auto;
  }

  .empty-state-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    color: var(--text-light);
  }

  .empty-state h4 {
    font-size: 1.5rem;
    color: var(--text-dark);
    margin-bottom: 0.5rem;
  }

  .empty-state p {
    color: var(--text-light);
    margin-bottom: 1.5rem;
  }

  @media (max-width: 1200px) {
    .students-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .face-recognition-info {
      flex-direction: column;
      align-items: stretch;
    }
  }

  @media (max-width: 768px) {
    .page-title {
      font-size: 1.75rem;
    }

    .class-info-card {
      padding: 1rem;
    }

    .class-code {
      font-size: 1.25rem;
    }

    .class-details {
      flex-direction: column;
      gap: 0.5rem;
    }

    .search-section .d-flex {
      flex-direction: column;
      align-items: stretch;
    }

    .search-box {
      max-width: 100%;
    }

    .students-grid {
      grid-template-columns: 1fr;
    }

    .students-header {
      flex-direction: column;
      align-items: stretch;
    }

    .attendance-summary {
      justify-content: space-between;
    }

    .attendance-buttons {
      flex-direction: column;
    }
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes slideIn { 
    from { transform: translateX(100%); opacity: 0; } 
    to { transform: translateX(0); opacity: 1; } 
  }
  @keyframes slideOut { 
    from { transform: translateX(0); opacity: 1; } 
    to { transform: translateX(100%); opacity: 0; } 
  }
</style>

{% block scripts %}
<script>
(function() {
  'use strict';
  
  // ==================== CONFIGURATION ====================
  const config = {
    apiBaseUrl: window.location.origin,
    classId: "{{ class.id }}",
    csrfToken: "{{ csrf_token() }}",
    lecturerId: "{{ user.user_id }}",
    markAttendanceUrl: "{{ url_for('attendance.mark_attendance') }}"
  };
  
  // ==================== STATE ====================
  let state = {
    faceRecognitionActive: false,
    statusCheckInterval: null,
    attendanceCheckInterval: null,
    frameProcessingInterval: null,
    studentMap: {},
    pollCount: 0,
    lastNotified: {},
    debugMode: false,
    cameraStream: null,
    videoElement: null,
    canvasElement: null,
    framesProcessed: 0,
    processingFrame: false
  };

  // ==================== DEBUG HELPERS ====================
  function debugLog(message, type = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    console.log(`[${timestamp}] [AttendanceUI] ${message}`);
    
    // Add to log panel
    addLogEntry(message, type);
    
    // Add to debug panel if enabled
    if (state.debugMode) {
      const debugOutput = document.getElementById('debugOutput');
      if (debugOutput) {
        const entry = document.createElement('div');
        entry.style.color = type === 'error' ? '#f87171' : type === 'success' ? '#4ade80' : '#94a3b8';
        entry.textContent = `[${timestamp}] ${message}`;
        debugOutput.appendChild(entry);
        debugOutput.scrollTop = debugOutput.scrollHeight;
      }
    }
  }

  function toggleDebug() {
    state.debugMode = !state.debugMode;
    const panel = document.getElementById('debugPanel');
    if (panel) {
      panel.style.display = state.debugMode ? 'block' : 'none';
    }
    debugLog(`Debug mode: ${state.debugMode ? 'ON' : 'OFF'}`, 'info');
  }

  // ==================== NORMALIZE & MATCH HELPERS ====================
  
  /**
   * Normalize a name for comparison
   */
  function normalizeName(name) {
    if (!name) return '';
    return String(name)
      .toLowerCase()
      .trim()
      .replace(/\s+/g, ' ');
  }

  /**
   * Build comprehensive student map with multiple lookup keys
   */
  function buildStudentMap() {
    const map = { 
      byId: {}, 
      byName: {}, 
      byFirstName: {},
      byUserId: {}, 
      byStudentId: {},
      byIdNumber: {},
      allCards: []
    };
    
    document.querySelectorAll('.student-card').forEach(card => {
      const id = card.dataset.id;
      const userId = card.dataset.userId;
      const studentId = card.dataset.studentId;
      const name = card.dataset.name;
      
      // Get the ID number from the card (e.g., "SW0001")
      const idNumberEl = card.querySelector('.student-id');
      const idNumber = idNumberEl ? idNumberEl.textContent.trim() : null;
      
      // Store card reference
      map.allCards.push({
        card: card,
        id: id,
        userId: userId,
        studentId: studentId,
        name: name,
        idNumber: idNumber
      });
      
      // Map by various IDs (all as strings for consistent comparison)
      if (id) map.byId[String(id)] = card;
      if (userId) map.byUserId[String(userId)] = card;
      if (studentId) map.byStudentId[String(studentId)] = card;
      if (idNumber) map.byIdNumber[normalizeName(idNumber)] = card;
      
      // Map by full name (normalized)
      if (name) {
        const normalizedName = normalizeName(name);
        map.byName[normalizedName] = card;
        
        // Also map by first name only
        const firstName = normalizedName.split(' ')[0];
        if (firstName && !map.byFirstName[firstName]) {
          map.byFirstName[firstName] = card;
        }
        
        // Also map by last name
        const nameParts = normalizedName.split(' ');
        if (nameParts.length > 1) {
          const lastName = nameParts[nameParts.length - 1];
          if (!map.byFirstName[lastName]) {
            map.byFirstName[lastName] = card;
          }
        }
      }
    });
    
    debugLog(`Student map built: ${map.allCards.length} cards`, 'info');
    debugLog(`  Names: ${Object.keys(map.byName).join(', ')}`, 'info');
    debugLog(`  IDs: ${Object.keys(map.byId).join(', ')}`, 'info');
    
    return map;
  }

  /**
   * Find student card using multiple matching strategies
   */
  function findStudentCard(record) {
    const studentName = record.name;
    const studentId = record.student_id;
    const attendanceId = record.attendance_id;
    
    let card = null;
    let matchMethod = '';
    
    debugLog(`üîç Finding card for: name="${studentName}", student_id="${studentId}"`, 'info');
    
    // STRATEGY 1: Try by student_id (most reliable - this is what the API returns)
    if (studentId !== undefined && studentId !== null) {
      const idStr = String(studentId);
      
      // Try direct ID match
      card = state.studentMap.byId[idStr];
      if (card) {
        matchMethod = `data-id="${idStr}"`;
      }
      
      // Try user-id match
      if (!card) {
        card = state.studentMap.byUserId[idStr];
        if (card) matchMethod = `data-user-id="${idStr}"`;
      }
      
      // Try student-id match
      if (!card) {
        card = state.studentMap.byStudentId[idStr];
        if (card) matchMethod = `data-student-id="${idStr}"`;
      }
    }
    
    // STRATEGY 2: Try exact full name match
    if (!card && studentName) {
      const normalizedName = normalizeName(studentName);
      card = state.studentMap.byName[normalizedName];
      if (card) matchMethod = `exact name "${normalizedName}"`;
    }
    
    // STRATEGY 3: Try first name match (for "Henry" matching "Henry Tan")
    if (!card && studentName) {
      const firstName = normalizeName(studentName).split(' ')[0];
      card = state.studentMap.byFirstName[firstName];
      if (card) matchMethod = `first name "${firstName}"`;
    }
    
    // STRATEGY 4: Fuzzy match - check if API name contains or is contained by card name
    if (!card && studentName) {
      const searchName = normalizeName(studentName);
      for (const [cardName, cardEl] of Object.entries(state.studentMap.byName)) {
        if (cardName.includes(searchName) || searchName.includes(cardName)) {
          card = cardEl;
          matchMethod = `fuzzy "${searchName}" ~ "${cardName}"`;
          break;
        }
      }
    }
    
    // STRATEGY 5: Loop through all cards and compare
    if (!card && studentId !== undefined) {
      const idStr = String(studentId);
      for (const info of state.studentMap.allCards) {
        if (String(info.id) === idStr || 
            String(info.userId) === idStr || 
            String(info.studentId) === idStr) {
          card = info.card;
          matchMethod = `loop match id="${idStr}"`;
          break;
        }
      }
    }
    
    if (card) {
      debugLog(`‚úÖ Found: ${matchMethod}`, 'success');
    } else {
      debugLog(`‚ùå NOT FOUND for name="${studentName}", student_id="${studentId}"`, 'error');
      debugLog(`   Available IDs: ${Object.keys(state.studentMap.byId).join(', ')}`, 'error');
      debugLog(`   Available names: ${Object.keys(state.studentMap.byName).join(', ')}`, 'error');
    }
    
    return card;
  }

  // ==================== INITIALIZE ====================
  function init() {
    console.log('üéì Attendance Manager Initialized (Browser Camera Mode)');
    console.log('üìã Class ID:', config.classId);
    
    state.studentMap = buildStudentMap();
    state.videoElement = document.getElementById('cameraPreview');
    state.canvasElement = document.getElementById('captureCanvas');
    
    startAttendancePolling();
    
    debugLog('System ready, polling started', 'success');
  }

  // ==================== FACE RECOGNITION ====================
  async function checkRecognitionStatus() {
    try {
      const response = await fetch(`${config.apiBaseUrl}/api/recognition/browser/stats`, {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' }
      });
      const data = await response.json();
      if (data.success && data.stats) {
        updateRecognizedCount(data.stats.total_marked || 0);
        return true;
      }
      return false;
    } catch (error) {
      console.error('Recognition status error:', error);
      return false;
    }
  }

  async function startFaceRecognition() {
    const startBtn = document.getElementById('startRecognitionBtn');
    startBtn.disabled = true;
    startBtn.innerHTML = '<span class="btn-icon">‚è≥</span> Initializing...';
    
    debugLog('Starting browser-based face recognition...', 'info');
    
    try {
      // Step 1: Initialize recognition session on server
      debugLog('Step 1: Initializing server session...', 'info');
      const initResponse = await fetch(`${config.apiBaseUrl}/api/recognition/browser/init`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          session_id: config.classId,
          class_id: config.classId
        })
      });
      const initData = await initResponse.json();
      
      if (!initData.success) {
        debugLog(`Initialization failed: ${initData.error}`, 'error');
        showToast(initData.error || 'Failed to initialize', 'warning');
        startBtn.disabled = false;
        startBtn.innerHTML = '<span class="btn-icon">‚ñ∂Ô∏è</span> Start Camera';
        return;
      }
      
      debugLog(`Server initialized: ${initData.students_count} students, ${initData.training_samples} samples`, 'success');
      
      // Step 2: Request camera access
      debugLog('Step 2: Requesting camera access...', 'info');
      startBtn.innerHTML = '<span class="btn-icon">üì∏</span> Requesting Camera...';
      
      try {
        state.cameraStream = await navigator.mediaDevices.getUserMedia({
          video: {
            width: { ideal: 640 },
            height: { ideal: 480 },
            facingMode: 'user'
          }
        });
        
        state.videoElement.srcObject = state.cameraStream;
        debugLog('Camera access granted', 'success');
        
      } catch (cameraError) {
        debugLog(`Camera error: ${cameraError.message}`, 'error');
        showToast('Camera access denied or not available', 'warning');
        startBtn.disabled = false;
        startBtn.innerHTML = '<span class="btn-icon">‚ñ∂Ô∏è</span> Start Camera';
        return;
      }
      
      // Step 3: Start frame processing
      state.faceRecognitionActive = true;
      state.framesProcessed = 0;
      updateRecognitionUI(true);
      startFrameProcessing();
      
      debugLog('Recognition started successfully!', 'success');
      showToast('Face recognition started!', 'success');
      
    } catch (error) {
      debugLog(`Error: ${error.message}`, 'error');
      showToast('Failed to start recognition', 'warning');
      startBtn.disabled = false;
      startBtn.innerHTML = '<span class="btn-icon">‚ñ∂Ô∏è</span> Start Camera';
    }
  }

  async function stopFaceRecognition() {
    const stopBtn = document.getElementById('stopRecognitionBtn');
    stopBtn.disabled = true;
    stopBtn.innerHTML = '<span class="btn-icon">‚è≥</span> Stopping...';
    
    try {
      // Stop frame processing
      stopFrameProcessing();
      
      // Stop camera stream
      if (state.cameraStream) {
        state.cameraStream.getTracks().forEach(track => track.stop());
        state.cameraStream = null;
        state.videoElement.srcObject = null;
      }
      
      // Notify server
      const response = await fetch(`${config.apiBaseUrl}/api/recognition/browser/stop`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      const data = await response.json();
      
      state.faceRecognitionActive = false;
      updateRecognitionUI(false);
      
      if (data.success && data.final_stats) {
        debugLog(`Session ended: ${data.final_stats.total_marked} students marked`, 'success');
        showToast(`Recognition stopped - ${data.final_stats.total_marked} students marked`, 'info');
      } else {
        debugLog('Recognition stopped', 'success');
        showToast('Recognition stopped', 'info');
      }
      
    } catch (error) {
      debugLog(`Error: ${error.message}`, 'error');
    }
    
    stopBtn.disabled = false;
    stopBtn.innerHTML = '<span class="btn-icon">‚èπÔ∏è</span> Stop Camera';
  }

  function startFrameProcessing() {
    if (state.frameProcessingInterval) {
      clearInterval(state.frameProcessingInterval);
    }
    
    // Process frames every 500ms (2 FPS) to avoid overloading
    state.frameProcessingInterval = setInterval(processCurrentFrame, 500);
    debugLog('Frame processing started (2 FPS)', 'info');
  }

  function stopFrameProcessing() {
    if (state.frameProcessingInterval) {
      clearInterval(state.frameProcessingInterval);
      state.frameProcessingInterval = null;
      debugLog('Frame processing stopped', 'info');
    }
  }

  async function processCurrentFrame() {
    if (state.processingFrame || !state.faceRecognitionActive) {
      return;
    }
    
    state.processingFrame = true;
    
    try {
      // Capture frame from video
      const canvas = state.canvasElement;
      const video = state.videoElement;
      
      if (!video.videoWidth || !video.videoHeight) {
        state.processingFrame = false;
        return;
      }
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0);
      
      // Convert to base64
      const frameData = canvas.toDataURL('image/jpeg', 0.8);
      
      // Send to server for processing
      const response = await fetch(`${config.apiBaseUrl}/api/recognition/browser/process`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ frame: frameData })
      });
      
      const data = await response.json();
      
      if (data.success) {
        state.framesProcessed++;
        document.getElementById('framesProcessed').textContent = state.framesProcessed;
        
        // Handle recognitions
        if (data.recognitions && data.recognitions.length > 0) {
          for (const rec of data.recognitions) {
            if (rec.marked) {
              debugLog(`‚úÖ ${rec.name} recognized and marked as ${rec.status}`, 'success');
              addLogEntry(`${rec.name} marked as ${rec.status} (confidence: ${(rec.confidence * 100).toFixed(1)}%)`, 'success');
              
              // Refresh attendance to show the update
              fetchAttendanceUpdates();
            } else if (rec.name === 'Unknown') {
              debugLog(`‚ö†Ô∏è Unknown face detected (confidence: ${(rec.confidence * 100).toFixed(1)}%)`, 'warn');
            }
          }
        }
      }
      
    } catch (error) {
      debugLog(`Frame processing error: ${error.message}`, 'error');
    } finally {
      state.processingFrame = false;
    }
  }

  function updateRecognitionUI(isRunning) {
    const statusEl = document.getElementById('recognitionStatus');
    const startBtn = document.getElementById('startRecognitionBtn');
    const stopBtn = document.getElementById('stopRecognitionBtn');
    const mainBtn = document.getElementById('faceRecognitionBtn');
    const mainBtnText = document.getElementById('faceRecognitionBtnText');
    
    if (isRunning) {
      statusEl.textContent = 'Running';
      statusEl.className = 'face-stat-value status-running';
      startBtn.disabled = true;
      startBtn.innerHTML = '<span class="btn-icon">‚úÖ</span> Camera Active';
      stopBtn.disabled = false;
      mainBtn.classList.add('btn-recognition-running');
      mainBtnText.textContent = 'Camera Active';
    } else {
      statusEl.textContent = 'Stopped';
      statusEl.className = 'face-stat-value status-stopped';
      startBtn.disabled = false;
      startBtn.innerHTML = '<span class="btn-icon">‚ñ∂Ô∏è</span> Start Camera';
      stopBtn.disabled = true;
      mainBtn.classList.remove('btn-recognition-running');
      mainBtnText.textContent = 'Face Recognition';
      document.getElementById('framesProcessed').textContent = '0';
    }
  }

  function addLogEntry(message, type = 'info') {
    const logContainer = document.getElementById('logContainer');
    if (!logContainer) return;
    
    const timestamp = new Date().toLocaleTimeString();
    const entry = document.createElement('div');
    entry.className = `log-entry ${type}`;
    entry.textContent = `[${timestamp}] ${message}`;
    
    logContainer.appendChild(entry);
    logContainer.scrollTop = logContainer.scrollHeight;
    
    while (logContainer.children.length > 100) {
      logContainer.removeChild(logContainer.firstChild);
    }
  }

  // ==================== POLLING ====================

  function startAttendancePolling() {
    if (state.attendanceCheckInterval) clearInterval(state.attendanceCheckInterval);
    state.attendanceCheckInterval = setInterval(fetchAttendanceUpdates, 2000);
    fetchAttendanceUpdates(); // Immediate fetch
  }

  function stopAttendancePolling() {
    if (state.attendanceCheckInterval) {
      clearInterval(state.attendanceCheckInterval);
      state.attendanceCheckInterval = null;
    }
  }

  // ==================== ATTENDANCE SYNC ====================
  async function fetchAttendanceUpdates() {
    state.pollCount++;
    
    try {
      const url = `${config.apiBaseUrl}/api/attendance/class/${config.classId}`;
      const response = await fetch(url, {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' }
      });
      
      const data = await response.json();
      
      // Update live indicator
      const liveText = document.getElementById('liveUpdateText');
      if (liveText) {
        liveText.textContent = `Live updates active - Poll #${state.pollCount} - ${data.count || 0} records`;
      }
      
      if (data.success && data.records && data.records.length > 0) {
        debugLog(`üì• Poll #${state.pollCount}: ${data.records.length} records from API`, 'info');
        
        // Log full API response for debugging
        if (state.debugMode) {
          debugLog(`API Response: ${JSON.stringify(data.records.map(r => ({
            name: r.name,
            student_id: r.student_id,
            status: r.status
          })))}`, 'info');
        }
        
        syncAttendanceWithAPI(data.records);
      }
      
      // Always update summary counts
      updateSummaryCounts();
      updateRecognizedCount();
      
    } catch (error) {
      debugLog(`Poll error: ${error.message}`, 'error');
    }
  }

  /**
   * Sync attendance records from API with UI cards
   */
  function syncAttendanceWithAPI(records) {
    for (const record of records) {
      const apiStatus = record.status;
      const studentName = record.name || 'Unknown';
      const recordedAt = record.recorded_at;
      
      if (!apiStatus) {
        debugLog(`‚ö†Ô∏è Record missing status: ${JSON.stringify(record)}`, 'warn');
        continue;
      }
      
      // Find the card using improved matching
      const card = findStudentCard(record);
      
      if (!card) {
        // Already logged in findStudentCard
        continue;
      }
      
      // Get current visual state
      const currentVisualStatus = getCardVisualStatus(card);
      
      // If visual doesn't match API, update it
      if (currentVisualStatus !== apiStatus) {
        debugLog(`üîÑ Updating ${studentName}: "${currentVisualStatus}" ‚Üí "${apiStatus}"`, 'info');
        applyVisualUpdate(card, apiStatus, recordedAt, studentName);
      }
    }
  }

  /**
   * Get the current visual status of a card by checking its classes
   */
  function getCardVisualStatus(card) {
    if (card.classList.contains('present')) return 'present';
    if (card.classList.contains('absent')) return 'absent';
    if (card.classList.contains('late')) return 'late';
    return 'unmarked';
  }

  /**
   * Apply visual update to a card
   */
  function applyVisualUpdate(card, status, recordedAt, studentName) {
    // Update CSS classes
    card.classList.remove('present', 'absent', 'late', 'pending', 'unmarked');
    card.classList.add(status);
    card.dataset.status = status;
    
    // Highlight animation
    if (status === 'present' || status === 'late') {
      card.classList.remove('just-updated');
      void card.offsetWidth; // Force reflow
      card.classList.add('just-updated');
    }
    
    // Update status badge
    const badge = card.querySelector('.status-badge');
    if (badge) {
      badge.className = `status-badge status-${status}`;
      badge.textContent = status.charAt(0).toUpperCase() + status.slice(1);
    }
    
    // Update buttons
    card.querySelectorAll('.attendance-btn').forEach(btn => {
      btn.classList.remove('active');
      if (btn.classList.contains(status)) {
        btn.classList.add('active');
      }
    });
    
    // Update timestamp
    const lastUpdated = card.querySelector('.last-updated');
    if (lastUpdated && recordedAt) {
      lastUpdated.textContent = recordedAt;
    }
    
    // Show toast (throttled)
    const now = Date.now();
    const lastNotifyTime = state.lastNotified[studentName] || 0;
    if (now - lastNotifyTime > 10000) {
      if (status === 'present' || status === 'late') {
        showToast(`${studentName} marked as ${status}`, 'success');
        debugLog(`‚úÖ ${studentName} ‚Üí ${status}`, 'success');
      }
      state.lastNotified[studentName] = now;
    }
  }

  function updateSummaryCounts() {
    let present = 0, absent = 0, late = 0;
    
    document.querySelectorAll('.student-card').forEach(card => {
      const status = getCardVisualStatus(card);
      if (status === 'present') present++;
      else if (status === 'absent') absent++;
      else if (status === 'late') late++;
    });
    
    document.getElementById('summaryPresent').textContent = present;
    document.getElementById('summaryAbsent').textContent = absent;
    document.getElementById('summaryLate').textContent = late;
  }

  function updateRecognizedCount(count) {
    const el = document.getElementById('recognizedCount');
    if (el) {
      if (count !== undefined) {
        el.textContent = count;
      } else {
        // Count from UI
        let uiCount = 0;
        document.querySelectorAll('.student-card').forEach(card => {
          const status = getCardVisualStatus(card);
          if (status === 'present' || status === 'late') uiCount++;
        });
        el.textContent = uiCount;
      }
    }
  }

  // ==================== UI FUNCTIONS ====================
  function toggleFaceRecognition() {
    const panel = document.getElementById('faceRecognitionStatus');
    const isHidden = panel.style.display === 'none';
    panel.style.display = isHidden ? 'block' : 'none';
    if (isHidden) checkRecognitionStatus();
  }

  function hideFaceRecognitionPanel() {
    document.getElementById('faceRecognitionStatus').style.display = 'none';
  }

  function markAttendance(studentId, status) {
    fetch(config.markAttendanceUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": config.csrfToken,
      },
      body: JSON.stringify({
        class_id: config.classId,
        lecturer_id: config.lecturerId,
        student_id: studentId,
        status: status,
      }),
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast(`Marked as ${status}`, "success");
          fetchAttendanceUpdates();
        } else {
          showToast(data.error || "Failed", "warning");
        }
      })
      .catch(error => {
        console.error("Error:", error);
        showToast("Error occurred", "warning");
      });
  }

  function saveNote(studentId, note) {
    return fetch(config.markAttendanceUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": config.csrfToken,
      },
      body: JSON.stringify({
        class_id: config.classId,
        lecturer_id: config.lecturerId,
        student_id: studentId,
        notes: note,
      }),
    }).then(response => response.json());
  }

  function searchStudents() {
    const term = document.getElementById("searchInput").value.toLowerCase();
    document.querySelectorAll(".student-card").forEach(card => {
      const name = card.querySelector("h4").textContent.toLowerCase();
      const id = card.querySelector(".student-id").textContent.toLowerCase();
      const email = card.querySelector(".student-email").textContent.toLowerCase();
      card.style.display = (name.includes(term) || id.includes(term) || email.includes(term)) ? "block" : "none";
    });
  }

  function filterStudents() {
    const filter = document.getElementById("statusFilter").value;
    document.querySelectorAll(".student-card").forEach(card => {
      const status = getCardVisualStatus(card);
      card.style.display = (filter === "all" || filter === status) ? "block" : "none";
    });
  }

  function refreshAttendance() {
    state.studentMap = buildStudentMap();
    fetchAttendanceUpdates();
    showToast('Refreshed', 'info');
  }

  function showToast(message, type = "info") {
    const toast = document.createElement("div");
    toast.textContent = message;
    toast.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: ${type === "success" ? "#f0fdf4" : type === "warning" ? "#fffbeb" : "#f0f9ff"};
      color: ${type === "success" ? "#059669" : type === "warning" ? "#d97706" : "#0891b2"};
      border: 2px solid ${type === "success" ? "#059669" : type === "warning" ? "#d97706" : "#0891b2"};
      padding: 1rem 1.5rem;
      border-radius: 8px;
      z-index: 1000;
      animation: slideIn 0.3s ease;
      font-weight: 600;
      max-width: 300px;
    `;
    document.body.appendChild(toast);
    setTimeout(() => {
      toast.style.animation = "slideOut 0.3s ease";
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  // ==================== PUBLIC API ====================
  window.AttendanceManager = {
    checkRecognitionStatus,
    startFaceRecognition,
    stopFaceRecognition,
    toggleFaceRecognition,
    hideFaceRecognitionPanel,
    markAttendance,
    saveNote,
    searchStudents,
    filterStudents,
    refreshAttendance,
    toggleDebug,
    // Debug helpers
    getStudentMap: () => state.studentMap,
    testFindCard: (record) => findStudentCard(record)
  };

  // Cleanup
  window.addEventListener('beforeunload', () => {
    stopFrameProcessing();
    stopAttendancePolling();
    
    // Stop camera if active
    if (state.cameraStream) {
      state.cameraStream.getTracks().forEach(track => track.stop());
    }
  });

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
{% endblock %} {% endblock %}