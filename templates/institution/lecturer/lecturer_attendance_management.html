{% extends "layouts/base.html" %} {% block title %}Attendance Management -
AttendAI{% endblock %} {% block content %}
<div class="attendance-management">
  <h1 class="page-title mb-4">Attendance Management</h1>

  <!-- Class Info Card -->
  <div class="class-info-card mb-4">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h2 class="class-code">
          {{ class.course_code }} - {{ class.section }}
        </h2>
        <div class="class-details">
          <span class="class-detail-item">
            <span class="detail-icon">üìÖ</span>
            {{ class.date }}
          </span>
          <span class="class-detail-item">
            <span class="detail-icon">üìç</span>
            {{ class.room }}
          </span>
          <span class="class-detail-item">
            <span class="detail-icon">üïê</span>
            {{ class.time }}
          </span>
        </div>
      </div>
      <div>
        <a
          href="{{ url_for('institution_lecturer.manage_classes', class_id=class.id) }}"
          class="btn-outline-custom"
          >Class Details</a
        >
      </div>
    </div>
  </div>

  <!-- Search and Filter Section -->
  <div class="search-section mb-4">
    <div
      class="d-flex flex-wrap gap-3 align-items-center justify-content-between"
    >
      <div class="d-flex flex-wrap gap-3">
        <div class="search-box">
          <input
            type="text"
            id="searchInput"
            placeholder="Search by name or ID..."
            onkeyup="AttendanceManager.searchStudents()"
          />
          <span class="search-icon">üîç</span>
        </div>

        <div class="filter-dropdown">
          <select
            id="statusFilter"
            class="filter-select"
            onchange="AttendanceManager.filterStudents()"
          >
            <option value="all">All Students</option>
            <option value="present">Present Only</option>
            <option value="absent">Absent Only</option>
            <option value="late">Late Only</option>
          </select>
        </div>

        <button class="btn-custom" onclick="AttendanceManager.refreshAttendance()">
          <span class="btn-icon">üîÑ</span>
          Refresh
        </button>
      </div>

      <div class="d-flex gap-3">
        <button class="btn-custom btn-recognition" id="faceRecognitionBtn" onclick="AttendanceManager.toggleWebcam()">
          <span class="btn-icon">üì∏</span>
          <span id="faceRecognitionBtnText">Start Face Recognition</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Live Update Indicator -->
  <div id="liveUpdateIndicator" class="live-update-indicator mb-3">
    <span class="pulse-dot"></span>
    <span id="liveUpdateText">Live updates active</span>
  </div>

  <!-- Webcam Recognition Panel -->
  <div id="webcamPanel" class="webcam-panel mb-4" style="display: none;">
    <div class="card-custom">
      <div class="card-header-custom d-flex justify-content-between align-items-center">
        <span>üé• Live Face Recognition</span>
        <button class="btn-close-panel" onclick="AttendanceManager.stopWebcam()">‚úï Close</button>
      </div>
      <div class="card-body-custom">
        <div class="webcam-container">
          <!-- Video and Canvas -->
          <div class="video-section">
            <div class="video-wrapper">
              <video id="webcamVideo" autoplay playsinline muted></video>
              <canvas id="overlayCanvas"></canvas>
              <div class="video-status" id="videoStatus">
                <div class="status-loading">
                  <div class="spinner"></div>
                  <span>Starting camera...</span>
                </div>
              </div>
            </div>
            
            <!-- Controls -->
            <div class="webcam-controls">
              <button class="btn-control" id="pauseBtn" onclick="AttendanceManager.togglePause()">
                <span id="pauseIcon">‚è∏Ô∏è</span>
                <span id="pauseText">Pause</span>
              </button>
              <button class="btn-control" onclick="AttendanceManager.switchCamera()">
                <span>üîÑ</span>
                <span>Switch Camera</span>
              </button>
              <div class="recognition-stats">
                <span class="stat-item">
                  <span class="stat-label">FPS:</span>
                  <span class="stat-value" id="fpsCounter">0</span>
                </span>
                <span class="stat-item">
                  <span class="stat-label">Recognized:</span>
                  <span class="stat-value" id="recognizedCounter">0</span>
                </span>
              </div>
            </div>
          </div>

          <!-- Recognition Log -->
          <div class="recognition-log-section">
            <h4>üìã Recognition Log</h4>
            <div class="log-container" id="recognitionLog">
              <div class="log-entry info">Waiting for camera...</div>
            </div>
            
            <!-- Recently Recognized -->
            <h4 class="mt-3">‚úÖ Recently Recognized</h4>
            <div class="recognized-list" id="recognizedList">
              <div class="empty-recognized">No students recognized yet</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Students Grid -->
  <div class="students-container">
    <div class="students-header mb-3">
      <h3>Student Roster</h3>
      <div class="attendance-summary">
        <span class="summary-item"
          >Total:
          <strong id="summaryTotal">{{ stats.total_students }}</strong></span
        >
        <span class="summary-item present"
          >Present:
          <strong id="summaryPresent"
            >{{ stats.present_students }}</strong
          ></span
        >
        <span class="summary-item absent"
          >Absent:
          <strong id="summaryAbsent">{{ stats.absent_students }}</strong></span
        >
        <span class="summary-item late"
          >Late:
          <strong id="summaryLate">{{ stats.late_students }}</strong></span
        >
      </div>
    </div>

    <div class="students-grid" id="studentsGrid">
      {% for student in students %}
      <div
        class="student-card card-custom {{ student.status | default('unmarked') }}"
        data-id="{{ student.id }}"
        data-user-id="{{ student.user_id | default(student.id) }}"
        data-student-id="{{ student.student_id | default(student.user_id) | default(student.id) }}"
        data-name="{{ student.name }}"
        data-status="{{ student.status | default('unmarked') }}"
      >
        <div class="student-header">
          <div class="student-photo">
            {% if student.photo_url %}
            <img src="{{ student.photo_url }}" alt="{{ student.name }}" />
            {% else %}
            <div class="student-photo-placeholder">{{ student.name[0] }}</div>
            {% endif %}
          </div>
          <div class="student-info">
            <h4 class="student-name">{{ student.name }}</h4>
            <p class="student-id">{{ student.id_number }}</p>
            <p class="student-email">{{ student.email }}</p>
          </div>
        </div>

        <div class="student-status">
          <span class="status-badge status-{{ student.status | default('unmarked') }}"
            >{{ student.status | default('Unmarked') }}</span
          >
          <span class="last-updated">{{ student.recorded_at | default('') }}</span>
        </div>

        <div class="attendance-controls">
          <div class="attendance-buttons">
            <button
              class="attendance-btn present {{ 'active' if student.status == 'present' }}"
              onclick="AttendanceManager.markAttendance('{{ student.id }}', 'present')"
              title="Mark as Present"
            >
              <span class="btn-icon">‚úì</span>
              Present
            </button>
            <button
              class="attendance-btn absent {{ 'active' if student.status == 'absent' }}"
              onclick="AttendanceManager.markAttendance('{{ student.id }}', 'absent')"
              title="Mark as Absent"
            >
              <span class="btn-icon">‚úï</span>
              Absent
            </button>
            <button
              class="attendance-btn late {{ 'active' if student.status == 'late' }}"
              onclick="AttendanceManager.markAttendance('{{ student.id }}', 'late')"
              title="Mark as Late"
            >
              <span class="btn-icon">üïê</span>
              Late
            </button>
          </div>

          <div class="attendance-notes">
            <input
              type="text"
              class="notes-input"
              placeholder="Add note..."
              value="{{ '' if student.notes and student.notes.startswith('{') else (student.notes | default('')) }}"
              oninput="AttendanceManager.saveNote('{{ student.id }}', this.value)"
            />
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    {% if not students %}
    <div class="empty-state card-custom">
      <div class="empty-state-content">
        <div class="empty-state-icon">üë•</div>
        <h4>No Students Found</h4>
        <p>This class doesn't have any students enrolled yet.</p>
        <a
          href="{{ url_for('institution_lecturer.manage_classes') }}"
          class="btn-custom"
          >Manage Roster</a
        >
      </div>
    </div>
    {% endif %}
  </div>
</div>

<style>
  .attendance-management {
    max-width: 1400px;
    margin: 0 auto;
  }

  .page-title {
    font-size: 2.5rem;
    font-weight: bold;
    font-style: italic;
    color: var(--text-dark);
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 1rem;
  }

  .live-update-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background-color: #f0fdf4;
    border: 1px solid #059669;
    border-radius: 8px;
    padding: 0.75rem 1rem;
    color: #059669;
    font-size: 0.9rem;
    font-weight: 500;
  }

  .pulse-dot {
    width: 10px;
    height: 10px;
    background-color: #059669;
    border-radius: 50%;
    animation: pulse-animation 1.5s infinite;
  }

  @keyframes pulse-animation {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.7; }
    100% { transform: scale(1); opacity: 1; }
  }

  .class-info-card {
    background-color: var(--primary-dark);
    color: white;
    border-radius: 15px;
    padding: 1.5rem 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .class-code {
    font-size: 1.75rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
  }

  .class-details {
    display: flex;
    gap: 2rem;
    flex-wrap: wrap;
  }

  .class-detail-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
  }

  .detail-icon {
    font-size: 1.25rem;
  }

  .search-section {
    background-color: var(--primary-light);
    border-radius: 15px;
    padding: 1.5rem;
    border: 2px solid var(--border-color);
  }

  .search-box {
    position: relative;
    flex: 1;
    max-width: 400px;
  }

  .search-box input {
    width: 100%;
    padding: 0.875rem 1rem 0.875rem 3rem;
    border: 2px solid var(--border-color);
    border-radius: 50px;
    background-color: white;
    font-size: 0.9rem;
    color: var(--text-dark);
  }

  .search-box input:focus {
    outline: none;
    border-color: var(--primary-dark);
  }

  .search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-light);
  }

  .filter-select {
    padding: 0.875rem 3rem 0.875rem 1rem;
    border: 2px solid var(--border-color);
    border-radius: 50px;
    background-color: white;
    font-size: 0.9rem;
    color: var(--text-dark);
    min-width: 180px;
  }

  .btn-icon {
    margin-right: 0.5rem;
  }

  .btn-recognition {
    background: linear-gradient(135deg, #059669 0%, #047857 100%) !important;
    border: none !important;
    color: white !important;
    padding: 0.875rem 1.5rem !important;
    font-weight: 600 !important;
  }

  .btn-recognition:hover {
    background: linear-gradient(135deg, #047857 0%, #065f46 100%) !important;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
  }

  .btn-recognition.active {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%) !important;
    animation: pulse-btn 2s infinite;
  }

  @keyframes pulse-btn {
    0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
    100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
  }

  /* Webcam Panel Styles */
  .webcam-panel {
    animation: slideDown 0.3s ease;
  }

  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .btn-close-panel {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    cursor: pointer;
    font-weight: 500;
    transition: background 0.2s;
  }

  .btn-close-panel:hover {
    background: rgba(255,255,255,0.3);
  }

  .webcam-container {
    display: grid;
    grid-template-columns: 1fr 350px;
    gap: 1.5rem;
  }

  .video-section {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .video-wrapper {
    position: relative;
    background: #000;
    border-radius: 12px;
    overflow: hidden;
    aspect-ratio: 4/3;
  }

  #webcamVideo {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform: scaleX(-1); /* Mirror */
  }

  #overlayCanvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    transform: scaleX(-1); /* Mirror to match video */
  }

  .video-status {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.7);
    color: white;
  }

  .video-status.hidden {
    display: none;
  }

  .status-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .webcam-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .btn-control {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    border: 2px solid var(--border-color);
    border-radius: 25px;
    background: white;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
  }

  .btn-control:hover {
    border-color: var(--primary-dark);
    background: var(--primary-light);
  }

  .recognition-stats {
    display: flex;
    gap: 1.5rem;
    margin-left: auto;
    padding: 0.5rem 1rem;
    background: #f1f5f9;
    border-radius: 25px;
  }

  .stat-item {
    display: flex;
    gap: 0.5rem;
    font-size: 0.9rem;
  }

  .stat-label {
    color: var(--text-light);
  }

  .stat-value {
    font-weight: 700;
    color: var(--primary-dark);
  }

  .recognition-log-section {
    display: flex;
    flex-direction: column;
  }

  .recognition-log-section h4 {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.75rem;
  }

  .log-container {
    flex: 1;
    max-height: 200px;
    overflow-y: auto;
    background: #f8fafc;
    border-radius: 8px;
    padding: 0.75rem;
    font-family: monospace;
    font-size: 0.8rem;
  }

  .log-entry {
    padding: 0.25rem 0;
    border-bottom: 1px solid #e2e8f0;
  }

  .log-entry:last-child {
    border-bottom: none;
  }

  .log-entry.success { color: #059669; }
  .log-entry.error { color: #dc2626; }
  .log-entry.info { color: #0891b2; }
  .log-entry.warn { color: #d97706; }

  .recognized-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    max-height: 200px;
    overflow-y: auto;
  }

  .recognized-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    background: #d1fae5;
    border-radius: 8px;
    border-left: 4px solid #059669;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateX(-10px); }
    to { opacity: 1; transform: translateX(0); }
  }

  .recognized-item.late {
    background: #fef3c7;
    border-left-color: #d97706;
  }

  .recognized-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #059669;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.9rem;
  }

  .recognized-item.late .recognized-avatar {
    background: #d97706;
  }

  .recognized-info {
    flex: 1;
  }

  .recognized-name {
    font-weight: 600;
    color: var(--text-dark);
    font-size: 0.9rem;
  }

  .recognized-time {
    font-size: 0.75rem;
    color: var(--text-light);
  }

  .recognized-status {
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    background: #059669;
    color: white;
  }

  .recognized-item.late .recognized-status {
    background: #d97706;
  }

  .empty-recognized {
    text-align: center;
    padding: 2rem;
    color: var(--text-light);
    font-size: 0.9rem;
  }

  /* Student Cards */
  .students-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .students-header h3 {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--text-dark);
    margin: 0;
  }

  .attendance-summary {
    display: flex;
    gap: 1.5rem;
  }

  .summary-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
  }

  .summary-item.present { color: #059669; }
  .summary-item.absent { color: #dc2626; }
  .summary-item.late { color: #d97706; }

  .summary-item strong {
    font-size: 1.1rem;
  }

  .students-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
  }

  .student-card {
    padding: 1.5rem;
    transition: all 0.3s ease;
    border-left: 4px solid #9ca3af;
  }

  .student-card.present { border-left-color: #059669; }
  .student-card.absent { border-left-color: #dc2626; }
  .student-card.late { border-left-color: #d97706; }

  .student-card.just-updated {
    animation: highlight-update 2s ease;
  }

  @keyframes highlight-update {
    0% { background-color: #d1fae5; transform: scale(1.02); }
    100% { background-color: white; transform: scale(1); }
  }

  .student-header {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .student-photo {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    overflow: hidden;
    border: 2px solid var(--border-color);
  }

  .student-photo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .student-photo-placeholder {
    width: 100%;
    height: 100%;
    background-color: var(--primary-light);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    font-weight: bold;
    color: var(--primary-dark);
    text-transform: uppercase;
  }

  .student-info h4 {
    font-size: 1.1rem;
    font-weight: bold;
    color: var(--text-dark);
    margin-bottom: 0.25rem;
  }

  .student-id {
    font-size: 0.85rem;
    color: var(--primary-dark);
    font-weight: 600;
    margin-bottom: 0.125rem;
  }

  .student-email {
    font-size: 0.8rem;
    color: var(--text-light);
  }

  .student-status {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid #e2e8f0;
  }

  .status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 50px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: capitalize;
  }

  .status-present {
    background-color: #f0fdf4;
    color: #059669;
    border: 1px solid #059669;
  }

  .status-absent {
    background-color: #fef2f2;
    color: #dc2626;
    border: 1px solid #dc2626;
  }

  .status-late {
    background-color: #fffbeb;
    color: #d97706;
    border: 1px solid #d97706;
  }

  .status-pending, .status-unmarked {
    background-color: #f3f4f6;
    color: #6b7280;
    border: 1px solid #9ca3af;
  }

  .last-updated {
    font-size: 0.75rem;
    color: var(--text-light);
  }

  .attendance-controls {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .attendance-buttons {
    display: flex;
    gap: 0.5rem;
  }

  .attendance-btn {
    flex: 1;
    padding: 0.5rem;
    border: 2px solid;
    border-radius: 8px;
    background-color: transparent;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
    transition: all 0.2s ease;
  }

  .attendance-btn.present {
    color: #059669;
    border-color: #059669;
  }

  .attendance-btn.present:hover,
  .attendance-btn.present.active {
    background-color: #059669;
    color: white;
  }

  .attendance-btn.absent {
    color: #dc2626;
    border-color: #dc2626;
  }

  .attendance-btn.absent:hover,
  .attendance-btn.absent.active {
    background-color: #dc2626;
    color: white;
  }

  .attendance-btn.late {
    color: #d97706;
    border-color: #d97706;
  }

  .attendance-btn.late:hover,
  .attendance-btn.late.active {
    background-color: #d97706;
    color: white;
  }

  .notes-input {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-size: 0.85rem;
    color: var(--text-dark);
  }

  .notes-input:focus {
    outline: none;
    border-color: var(--primary-dark);
  }

  .empty-state {
    text-align: center;
    padding: 3rem;
  }

  .empty-state-content {
    max-width: 400px;
    margin: 0 auto;
  }

  .empty-state-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    color: var(--text-light);
  }

  .empty-state h4 {
    font-size: 1.5rem;
    color: var(--text-dark);
    margin-bottom: 0.5rem;
  }

  .empty-state p {
    color: var(--text-light);
    margin-bottom: 1.5rem;
  }

  /* Responsive */
  @media (max-width: 1200px) {
    .students-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .webcam-container {
      grid-template-columns: 1fr;
    }

    .recognition-log-section {
      order: -1;
    }
  }

  @media (max-width: 768px) {
    .page-title {
      font-size: 1.75rem;
    }

    .class-info-card {
      padding: 1rem;
    }

    .class-code {
      font-size: 1.25rem;
    }

    .class-details {
      flex-direction: column;
      gap: 0.5rem;
    }

    .search-section .d-flex {
      flex-direction: column;
      align-items: stretch;
    }

    .search-box {
      max-width: 100%;
    }

    .students-grid {
      grid-template-columns: 1fr;
    }

    .students-header {
      flex-direction: column;
      align-items: stretch;
    }

    .attendance-summary {
      justify-content: space-between;
    }

    .attendance-buttons {
      flex-direction: column;
    }

    .webcam-controls {
      justify-content: center;
    }

    .recognition-stats {
      margin-left: 0;
      width: 100%;
      justify-content: center;
    }
  }
</style>

{% block scripts %}
<script>
(function() {
  'use strict';
  
  // ==================== CONFIGURATION ====================
  const config = {
    apiBaseUrl: window.location.origin,
    classId: "{{ class.id }}",
    csrfToken: "{{ csrf_token() }}",
    lecturerId: "{{ user.user_id }}",
    markAttendanceUrl: "{{ url_for('attendance.mark_attendance') }}",
    sessionStartTime: "{{ class.time.split('-')[0].strip() if class.time and '-' in class.time else '00:00' }}",
    lateThresholdMinutes: 30
  };
  
  // ==================== STATE ====================
  let state = {
    webcamActive: false,
    isPaused: false,
    video: null,
    canvas: null,
    ctx: null,
    stream: null,
    animationId: null,
    recognitionInterval: null,
    facingMode: 'user',
    studentMap: {},
    recognizedStudents: new Set(),
    lastRecognitionTime: {},
    frameCount: 0,
    lastFpsUpdate: Date.now(),
    fps: 0,
    attendanceCheckInterval: null,
    pollCount: 0
  };

  // ==================== INITIALIZATION ====================
  function init() {
    console.log('üéì Attendance Manager with Browser Webcam Initialized');
    console.log('üìã Class ID:', config.classId);
    
    state.studentMap = buildStudentMap();
    state.video = document.getElementById('webcamVideo');
    state.canvas = document.getElementById('overlayCanvas');
    state.ctx = state.canvas.getContext('2d');
    
    startAttendancePolling();
  }

  function buildStudentMap() {
    const map = { byId: {}, byName: {}, byUserId: {}, allCards: [] };
    
    document.querySelectorAll('.student-card').forEach(card => {
      const id = card.dataset.id;
      const userId = card.dataset.userId;
      const studentId = card.dataset.studentId;
      const name = card.dataset.name;
      
      map.allCards.push({ card, id, userId, studentId, name });
      if (id) map.byId[String(id)] = card;
      if (userId) map.byUserId[String(userId)] = card;
      if (name) map.byName[name.toLowerCase().trim()] = card;
    });
    
    return map;
  }

  // ==================== WEBCAM FUNCTIONS ====================
  async function toggleWebcam() {
    if (state.webcamActive) {
      stopWebcam();
    } else {
      await startWebcam();
    }
  }

  async function startWebcam() {
    const panel = document.getElementById('webcamPanel');
    const btn = document.getElementById('faceRecognitionBtn');
    const btnText = document.getElementById('faceRecognitionBtnText');
    const videoStatus = document.getElementById('videoStatus');
    
    panel.style.display = 'block';
    btn.classList.add('active');
    btnText.textContent = 'Stop Recognition';
    videoStatus.classList.remove('hidden');
    
    try {
      const constraints = {
        video: {
          facingMode: state.facingMode,
          width: { ideal: 640 },
          height: { ideal: 480 }
        },
        audio: false
      };
      
      state.stream = await navigator.mediaDevices.getUserMedia(constraints);
      state.video.srcObject = state.stream;
      
      state.video.onloadedmetadata = () => {
        state.canvas.width = state.video.videoWidth;
        state.canvas.height = state.video.videoHeight;
        videoStatus.classList.add('hidden');
        state.webcamActive = true;
        addLog('Camera started successfully', 'success');
        startRecognitionLoop();
      };
      
    } catch (error) {
      console.error('Camera error:', error);
      addLog(`Camera error: ${error.message}`, 'error');
      videoStatus.innerHTML = `
        <div class="status-loading">
          <span style="font-size: 2rem;">‚ùå</span>
          <span>Camera access denied</span>
          <span style="font-size: 0.8rem; opacity: 0.7;">Please allow camera access and try again</span>
        </div>
      `;
      
      btn.classList.remove('active');
      btnText.textContent = 'Start Face Recognition';
    }
  }

  function stopWebcam() {
    const panel = document.getElementById('webcamPanel');
    const btn = document.getElementById('faceRecognitionBtn');
    const btnText = document.getElementById('faceRecognitionBtnText');
    
    // Stop recognition loop
    if (state.animationId) {
      cancelAnimationFrame(state.animationId);
      state.animationId = null;
    }
    
    if (state.recognitionInterval) {
      clearInterval(state.recognitionInterval);
      state.recognitionInterval = null;
    }
    
    // Stop video stream
    if (state.stream) {
      state.stream.getTracks().forEach(track => track.stop());
      state.stream = null;
    }
    
    if (state.video) {
      state.video.srcObject = null;
    }
    
    state.webcamActive = false;
    state.isPaused = false;
    
    panel.style.display = 'none';
    btn.classList.remove('active');
    btnText.textContent = 'Start Face Recognition';
    
    addLog('Camera stopped', 'info');
  }

  function togglePause() {
    state.isPaused = !state.isPaused;
    const pauseIcon = document.getElementById('pauseIcon');
    const pauseText = document.getElementById('pauseText');
    
    if (state.isPaused) {
      pauseIcon.textContent = '‚ñ∂Ô∏è';
      pauseText.textContent = 'Resume';
      addLog('Recognition paused', 'warn');
    } else {
      pauseIcon.textContent = '‚è∏Ô∏è';
      pauseText.textContent = 'Pause';
      addLog('Recognition resumed', 'info');
    }
  }

  async function switchCamera() {
    state.facingMode = state.facingMode === 'user' ? 'environment' : 'user';
    addLog(`Switching to ${state.facingMode === 'user' ? 'front' : 'back'} camera`, 'info');
    
    if (state.webcamActive) {
      stopWebcam();
      setTimeout(() => startWebcam(), 500);
    }
  }

  // ==================== RECOGNITION LOOP ====================
  function startRecognitionLoop() {
    let lastRecognitionSent = 0;
    const recognitionInterval = 1000; // Send frame for recognition every 1 second
    
    function loop() {
      if (!state.webcamActive) return;
      
      state.frameCount++;
      const now = Date.now();
      
      // Update FPS every second
      if (now - state.lastFpsUpdate >= 1000) {
        state.fps = state.frameCount;
        state.frameCount = 0;
        state.lastFpsUpdate = now;
        document.getElementById('fpsCounter').textContent = state.fps;
      }
      
      // Draw video frame to canvas for processing
      if (!state.isPaused && state.video.readyState === state.video.HAVE_ENOUGH_DATA) {
        state.ctx.drawImage(state.video, 0, 0);
        
        // Send frame for recognition periodically
        if (now - lastRecognitionSent >= recognitionInterval) {
          lastRecognitionSent = now;
          sendFrameForRecognition();
        }
      }
      
      state.animationId = requestAnimationFrame(loop);
    }
    
    loop();
  }

  async function sendFrameForRecognition() {
    if (state.isPaused || !state.webcamActive) return;
    
    try {
      // Capture frame as base64
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = 320; // Smaller for faster upload
      tempCanvas.height = 240;
      const tempCtx = tempCanvas.getContext('2d');
      tempCtx.drawImage(state.video, 0, 0, 320, 240);
      
      const frameData = tempCanvas.toDataURL('image/jpeg', 0.7);
      
      // Send to server for recognition
      const response = await fetch(`${config.apiBaseUrl}/api/recognize-frame`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': config.csrfToken
        },
        body: JSON.stringify({
          frame: frameData,
          session_id: config.classId
        })
      });
      
      const data = await response.json();
      
      if (data.success && data.faces && data.faces.length > 0) {
        processRecognitionResults(data.faces);
      }
      
    } catch (error) {
      // Silently handle errors to avoid spamming console
      if (error.message.includes('NetworkError')) {
        addLog('Network error - retrying...', 'warn');
      }
    }
  }

  function processRecognitionResults(faces) {
    for (const face of faces) {
      const { name, confidence, student_id, status } = face;
      
      if (!name || name === 'Unknown' || confidence < 0.7) continue;
      
      // Check if already recognized recently (within 30 seconds)
      const lastTime = state.lastRecognitionTime[name] || 0;
      if (Date.now() - lastTime < 30000) continue;
      
      state.lastRecognitionTime[name] = Date.now();
      
      // Mark attendance
      if (student_id && !state.recognizedStudents.has(student_id)) {
        markAttendanceFromRecognition(student_id, name, status || 'present', confidence);
        state.recognizedStudents.add(student_id);
      }
    }
  }

  async function markAttendanceFromRecognition(studentId, name, status, confidence) {
    try {
      const response = await fetch(`${config.apiBaseUrl}/api/attendance/mark`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': config.csrfToken
        },
        body: JSON.stringify({
          student_id: studentId,
          session_id: config.classId,
          class_id: config.classId,
          status: status,
          recognition_data: {
            confidence: confidence,
            source: 'browser_webcam',
            timestamp: new Date().toISOString()
          }
        })
      });
      
      const data = await response.json();
      
      if (data.success && !data.already_present) {
        addLog(`‚úÖ ${name} marked as ${status} (${Math.round(confidence * 100)}%)`, 'success');
        addRecognizedStudent(name, status);
        updateRecognizedCounter();
        
        // Update UI immediately
        const card = findStudentCard({ name, student_id: studentId });
        if (card) {
          applyVisualUpdate(card, status, new Date().toLocaleTimeString(), name);
        }
        
        showToast(`${name} marked as ${status}`, 'success');
      } else if (data.already_present) {
        addLog(`${name} already marked`, 'info');
      }
      
    } catch (error) {
      addLog(`Error marking ${name}: ${error.message}`, 'error');
    }
  }

  function addRecognizedStudent(name, status) {
    const list = document.getElementById('recognizedList');
    const emptyMsg = list.querySelector('.empty-recognized');
    if (emptyMsg) emptyMsg.remove();
    
    const item = document.createElement('div');
    item.className = `recognized-item ${status === 'late' ? 'late' : ''}`;
    item.innerHTML = `
      <div class="recognized-avatar">${name.charAt(0).toUpperCase()}</div>
      <div class="recognized-info">
        <div class="recognized-name">${name}</div>
        <div class="recognized-time">${new Date().toLocaleTimeString()}</div>
      </div>
      <span class="recognized-status">${status.toUpperCase()}</span>
    `;
    
    list.insertBefore(item, list.firstChild);
    
    // Keep only last 10
    while (list.children.length > 10) {
      list.removeChild(list.lastChild);
    }
  }

  function updateRecognizedCounter() {
    document.getElementById('recognizedCounter').textContent = state.recognizedStudents.size;
  }

  function addLog(message, type = 'info') {
    const log = document.getElementById('recognitionLog');
    const entry = document.createElement('div');
    entry.className = `log-entry ${type}`;
    entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
    log.appendChild(entry);
    log.scrollTop = log.scrollHeight;
    
    // Keep only last 50 entries
    while (log.children.length > 50) {
      log.removeChild(log.firstChild);
    }
  }

  // ==================== ATTENDANCE POLLING ====================
  function startAttendancePolling() {
    if (state.attendanceCheckInterval) clearInterval(state.attendanceCheckInterval);
    state.attendanceCheckInterval = setInterval(fetchAttendanceUpdates, 3000);
    fetchAttendanceUpdates();
  }

  async function fetchAttendanceUpdates() {
    state.pollCount++;
    
    try {
      const response = await fetch(`${config.apiBaseUrl}/api/attendance/class/${config.classId}`);
      const data = await response.json();
      
      document.getElementById('liveUpdateText').textContent = 
        `Live updates active - ${data.count || 0} attendance records`;
      
      if (data.success && data.records) {
        syncAttendanceWithAPI(data.records);
      }
      
      updateSummaryCounts();
      
    } catch (error) {
      console.error('Poll error:', error);
    }
  }

  function syncAttendanceWithAPI(records) {
    for (const record of records) {
      const card = findStudentCard(record);
      if (!card) continue;
      
      const currentStatus = getCardVisualStatus(card);
      if (currentStatus !== record.status) {
        applyVisualUpdate(card, record.status, record.recorded_at, record.name);
      }
    }
  }

  function findStudentCard(record) {
    const { name, student_id } = record;
    
    if (student_id) {
      const idStr = String(student_id);
      const card = state.studentMap.byId[idStr] || state.studentMap.byUserId[idStr];
      if (card) return card;
    }
    
    if (name) {
      const card = state.studentMap.byName[name.toLowerCase().trim()];
      if (card) return card;
    }
    
    return null;
  }

  function getCardVisualStatus(card) {
    if (card.classList.contains('present')) return 'present';
    if (card.classList.contains('absent')) return 'absent';
    if (card.classList.contains('late')) return 'late';
    return 'unmarked';
  }

  function applyVisualUpdate(card, status, recordedAt, studentName) {
    card.classList.remove('present', 'absent', 'late', 'unmarked');
    card.classList.add(status);
    card.dataset.status = status;
    
    card.classList.remove('just-updated');
    void card.offsetWidth;
    card.classList.add('just-updated');
    
    const badge = card.querySelector('.status-badge');
    if (badge) {
      badge.className = `status-badge status-${status}`;
      badge.textContent = status.charAt(0).toUpperCase() + status.slice(1);
    }
    
    card.querySelectorAll('.attendance-btn').forEach(btn => {
      btn.classList.remove('active');
      if (btn.classList.contains(status)) btn.classList.add('active');
    });
    
    const lastUpdated = card.querySelector('.last-updated');
    if (lastUpdated && recordedAt) lastUpdated.textContent = recordedAt;
  }

  function updateSummaryCounts() {
    let present = 0, absent = 0, late = 0;
    
    document.querySelectorAll('.student-card').forEach(card => {
      const status = getCardVisualStatus(card);
      if (status === 'present') present++;
      else if (status === 'absent') absent++;
      else if (status === 'late') late++;
    });
    
    document.getElementById('summaryPresent').textContent = present;
    document.getElementById('summaryAbsent').textContent = absent;
    document.getElementById('summaryLate').textContent = late;
  }

  // ==================== MANUAL ATTENDANCE ====================
  function markAttendance(studentId, status) {
    fetch(config.markAttendanceUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": config.csrfToken,
      },
      body: JSON.stringify({
        class_id: config.classId,
        lecturer_id: config.lecturerId,
        student_id: studentId,
        status: status,
      }),
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast(`Marked as ${status}`, "success");
          fetchAttendanceUpdates();
        } else {
          showToast(data.error || "Failed", "warning");
        }
      })
      .catch(error => {
        console.error("Error:", error);
        showToast("Error occurred", "warning");
      });
  }

  function saveNote(studentId, note) {
    return fetch(config.markAttendanceUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": config.csrfToken,
      },
      body: JSON.stringify({
        class_id: config.classId,
        lecturer_id: config.lecturerId,
        student_id: studentId,
        notes: note,
      }),
    }).then(response => response.json());
  }

  function searchStudents() {
    const term = document.getElementById("searchInput").value.toLowerCase();
    document.querySelectorAll(".student-card").forEach(card => {
      const name = card.querySelector("h4").textContent.toLowerCase();
      const id = card.querySelector(".student-id").textContent.toLowerCase();
      card.style.display = (name.includes(term) || id.includes(term)) ? "block" : "none";
    });
  }

  function filterStudents() {
    const filter = document.getElementById("statusFilter").value;
    document.querySelectorAll(".student-card").forEach(card => {
      const status = getCardVisualStatus(card);
      card.style.display = (filter === "all" || filter === status) ? "block" : "none";
    });
  }

  function refreshAttendance() {
    state.studentMap = buildStudentMap();
    fetchAttendanceUpdates();
    showToast('Refreshed', 'info');
  }

  function showToast(message, type = "info") {
    const toast = document.createElement("div");
    toast.textContent = message;
    toast.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: ${type === "success" ? "#f0fdf4" : type === "warning" ? "#fffbeb" : "#f0f9ff"};
      color: ${type === "success" ? "#059669" : type === "warning" ? "#d97706" : "#0891b2"};
      border: 2px solid ${type === "success" ? "#059669" : type === "warning" ? "#d97706" : "#0891b2"};
      padding: 1rem 1.5rem;
      border-radius: 8px;
      z-index: 1001;
      font-weight: 600;
      max-width: 300px;
      animation: slideIn 0.3s ease;
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  // ==================== PUBLIC API ====================
  window.AttendanceManager = {
    toggleWebcam,
    stopWebcam,
    togglePause,
    switchCamera,
    markAttendance,
    saveNote,
    searchStudents,
    filterStudents,
    refreshAttendance
  };

  // Cleanup on page unload
  window.addEventListener('beforeunload', () => {
    stopWebcam();
    if (state.attendanceCheckInterval) clearInterval(state.attendanceCheckInterval);
  });

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
{% endblock %} {% endblock %}