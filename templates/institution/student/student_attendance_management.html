{% extends "layouts/base.html" %}

{% block title %}My Attendance - AttendAI{% endblock %}

{% block content %}

<style>
    /* Student Attendance Management Specific Styles */
    .student-attendance-management {
        width: 100%;
    }

    .page-header {
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 1rem;
    }

    .page-title {
        font-size: 2.5rem;
        font-weight: bold;
        font-style: italic;
        color: var(--text-dark);
        margin-bottom: 0.5rem;
    }

    .breadcrumb {
        font-size: 0.9rem;
        color: var(--text-light);
    }

    .breadcrumb a {
        color: var(--primary-dark);
        text-decoration: none;
    }

    .breadcrumb a:hover {
        text-decoration: underline;
    }

    .breadcrumb span {
        color: var(--text-dark);
        font-weight: 500;
    }

    
    /* 3-column layout */
    .student-attendance-management .attendance-grid {
        display: grid;
        grid-template-columns: 1fr 1.8fr 1.3fr;
        gap: 24px;
        align-items: start;
    }

    /* Remove fixed widths to prevent wrapping */
    .left-column,
    .dashboard-col-left,
    .dashboard-col-middle,
    .dashboard-col-right {
        min-width: 0;
    }

    .left-column {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    /* Term Information */
    .info-grid {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--border-color);
    }

    .info-item:last-child {
        border-bottom: none;
    }

    .info-item.highlight {
        background-color: var(--primary-light);
        padding: 0.75rem;
        border-radius: 8px;
        margin-top: 0.5rem;
        border: 1px solid var(--border-color);
    }

    .info-label {
        font-weight: 600;
        color: var(--text-dark);
        font-size: 0.9rem;
    }

    .info-value {
        color: var(--text-dark);
        font-weight: 500;
        font-size: 0.9rem;
    }

    .history-description {
        color: var(--text-light);
        font-size: 0.9rem;
        line-height: 1.5;
    }

    .btn-history {
        width: 100%;
        padding: 0.75rem;
        border-radius: 25px;
        font-size: 0.9rem;
        text-align: center;
        background-color: var(--primary-dark);
        color: white;
        text-decoration: none;
        display: block;
    }

    .btn-history:hover {
        background-color: #1e293b;
        color: white;
        text-decoration: none;
    }

    /* Monthly Statistics */
    .months-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        justify-items: center;
        align-items: start;
        justify-content: center;
        margin: 0 auto;
        box-sizing: border-box;
    }

    /* ensure Monthly Attendance card doesn't clip content */
    .card-custom:has(.months-grid) {
        overflow: visible;
    }
    
    .card-custom:has(.months-grid) .card-body-custom {
        overflow: visible;
    }

    .month-item {
        width: 260px;
        max-width: 100%;
        background-color: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 1.25rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: box-shadow 0.2s ease;
        margin: 0;
        box-sizing: border-box;
    }

    .month-item:hover {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* Monthly Attendance card */
    .student-attendance-management .month-item {
        padding: 1rem;
        gap: 8px;
    }

    .student-attendance-management .month-header {
        gap: 6px;
    }

    .student-attendance-management .month-stats {
        gap: 6px;
    }

    .month-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        width: 100%;
    }

    .month-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-dark);
        margin: 0;
    }

    .month-status {
        font-size: 0.7rem;
        font-weight: 600;
        padding: 0.2rem 0.6rem;
        border-radius: 12px;
        display: inline-block;
    }

    .month-status.good {
        background-color: #d1fae5;
        color: #065f46;
        border: 1px solid #10b981;
    }

    .month-status.warning {
        background-color: #fef3c7;
        color: #92400e;
        border: 1px solid #f59e0b;
    }

    /* Charts */
    .chart-container {
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        line-height: 0;
    }

    .chart-container.large {
        width: 150px;
        height: 150px;
    }

    .chart {
        width: 120px;
        height: 120px;
        display: block;
        margin: 0 auto;
    }

    /* Monthly Attendance card */
    .student-attendance-management .months-grid .chart {
        width: 95px;
        height: 95px;
        display: block;
        margin: 0 auto;
    }

    .chart svg {
        width: 100%;
        height: 100%;
        transform: rotate(-90deg);
        display: block;
    }

    .chart-bg {
        fill: none;
        stroke: #e0e7ef;
        stroke-width: 12;
    }

    .chart-segment {
        stroke: none;
        transition: opacity 0.3s ease;
    }

    .chart-segment-present {
        fill: #15c285;
    }

    .chart-segment-late {
        fill: #f59e0b;
    }

    .chart-segment-excused {
        fill: #6098e7;
    }

    .chart-segment-absent {
        fill: #ef4444;
    }

    /* Month Stats */
    .month-stats {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 100%;
    }

    .stat {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.85rem;
    }

    .stat-label {
        color: var(--text-light);
    }

    .stat-value {
        font-weight: 600;
    }

    .stat-value.present {
        color: #14b8a6;
    }

    .stat-value.late {
        color: #f59e0b;
    }

    .stat-value.excused {
        color: #6098e7;
    }

    .stat-value.absent {
        color: #ef4444;
    }

    /* Term Overview */
    .term-overview {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    .overall-stats {
        padding: 1.5rem;
        background-color: white;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* Term Overview layout --- */
    .term-summary {
        display: flex;
        flex-direction: column;
        gap: 18px;
    }

    .term-top {
        display: flex;
        align-items: center;
        gap: 20px;
        justify-content: flex-start;
    }

    .term-pie {
        flex: 0 0 140px;
        width: 140px;
        height: 140px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0;
    }

    .term-pie .chart-container {
        width: 100%;
        height: 100%;
    }

    .term-pie .chart-container.large {
        width: 100%;
        height: 100%;
    }

    .term-pie svg,
    .term-pie canvas,
    .term-pie img,
    .term-pie .chart {
        width: 100%;
        height: 100%;
        display: block;
    }

    .student-attendance-management .term-pie {
        flex: 0 0 154px;
        width: 154px;
        height: 154px;
    }

    .student-attendance-management .term-top {
        gap: 26px;
    }

    .student-attendance-management .overall-stats {
        width: 100%;
    }

    .term-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        text-align: left;
    }

    .term-title {
        font-weight: 800;
        font-size: 18px;
        line-height: 1.2;
        margin-bottom: 6px;
        color: var(--text-dark);
    }

    .term-percent {
        font-weight: 900;
        font-size: 44px;
        line-height: 1;
        color: var(--primary-dark);
    }

    /* term attednance alert layout */
    .term-status-row {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        margin-top: 16px;
    }

    .status-badge {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
        background-color: #d1fae5;
        color: #065f46;
        padding: 12px 16px;
        border-radius: 16px;
        font-size: 0.85rem;
        font-weight: 600;
        border: 1px solid #10b981;
        width: 90%;
        max-width: 520px;
        margin: 0 auto;
        line-height: 1.4;
        text-align: center;
    }

    .status-dot {
        display: none;
    }

    /* Stats aligned */
    .term-stats {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 16px;
    }

    .term-stat {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 12px;
        font-size: 0.9rem;
    }

    .term-stat span {
        color: #6b7280;
    }

    .term-stat strong {
        font-weight: 600;
        color: var(--text-dark);
    }

    /* Responsive */
    @media (max-width: 480px) {
        .term-top {
            flex-direction: column;
            align-items: center;
        }
        .term-pie {
            margin-bottom: 12px;
        }
        .term-main {
            text-align: center;
        }
        .term-status-row {
            justify-content: center;
        }
        .status-badge {
            width: 100%;
            max-width: 100%;
        }
    }

    /* Absent Classes */
    .absent-section {
        margin-top: 1.5rem;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--border-color);
    }

    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-dark);
    }

    .section-count {
        font-size: 0.9rem;
        color: var(--text-light);
        background-color: var(--primary-light);
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        text-decoration: none;
        display: inline-block;
        transition: all 0.2s ease;
    }

    .section-count:hover {
        background-color: var(--primary-dark);
        color: white;
        text-decoration: none;
    }

    .absent-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .absent-item {
        background-color: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 1.25rem;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .absent-item:hover {
        background-color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .absent-info {
        flex: 1;
    }

    .absent-class {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        margin-bottom: 0.75rem;
    }

    .absent-class strong {
        color: var(--primary-dark);
        font-size: 1rem;
    }

    .absent-class span {
        color: var(--text-light);
        font-size: 0.85rem;
    }

    /* Course code + badge row */
    .absent-section .absent-class .flex-column.justify-between {
        display: flex;
        flex-direction: row !important;
        align-items: center;
        justify-content: flex-start;
        gap: 12px;
        width: 100%;
    }
    .absent-section .absent-class {
        text-align: left;
    }
    .absent-section .absent-class strong {
        font-size: 22px;
        font-weight: 700;
    }

    .absent-details {
        display: grid;
        grid-template-columns: repeat(1, auto);
        gap: 1rem;
    }

    .absent-actions {
        flex-shrink: 0;
        margin-left: 1rem;
    }

    .btn-appeal {
        padding: 0.5rem 1.5rem;
        border-radius: 20px;
        font-size: 0.85rem;
        background-color: var(--primary-dark);
        color: white;
        border: none;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        text-align: center;
    }

    .btn-appeal:hover {
        background-color: #1e293b;
        color: white;
        text-decoration: none;
    }

    /* Appeal button */
    .absent-section .absent-item .btn-appeal {
        display: block;
        margin: 16px auto 0;
    }

    .view-all {
        text-align: center;
        padding-top: 1rem;
        border-top: none;
    }

    .view-all-link {
        color: var(--primary-dark);
        text-decoration: none;
        font-weight: 600;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s ease;
    }

    .view-all-link:hover {
        text-decoration: underline;
        color: var(--primary-dark);
    }

    /* Responsive Design */
    @media (max-width: 992px) {
        .attendance-grid,
        .student-attendance-management .attendance-grid {
            grid-template-columns: 1fr;
            gap: 24px;
        }
    }

    @media (max-width: 1100px) {
        .months-grid {
            grid-template-columns: 1fr;
        }
        
        .month-item {
            width: 100%;
            max-width: 280px;
        }
    }

    @media (max-width: 768px) {
        .page-title {
            font-size: 1.75rem;
        }

        .attendance-grid,
        .student-attendance-management .attendance-grid {
            grid-template-columns: 1fr;
        }

        .left-column {
            grid-column: span 1;
            grid-template-columns: 1fr;
        }

        .overall-stats {
            flex-direction: column;
            text-align: center;
            gap: 1.5rem;
        }

        .absent-details {
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }

        .absent-item {
            flex-direction: column;
            gap: 1rem;
            text-align: center;
        }

        .absent-actions {
            margin-left: 0;
            width: 100%;
        }

        .btn-appeal {
            width: 100%;
        }

        .breadcrumb {
            font-size: 0.8rem;
        }
    }

    @media (max-width: 480px) {
        .page-title {
            font-size: 1.5rem;
        }

        .overall-percentage {
            font-size: 2rem;
        }

        .chart-container {
            width: 100px;
            height: 100px;
        }

        .chart-container.large {
            width: 120px;
            height: 120px;
        }
    }
</style>

<div class="student-attendance-management">
    <!-- Page Header -->
    <div class="page-header mb-4">
        <h1 class="page-title">My Attendance</h1>
        <div class="breadcrumb">
            <a href="{{ url_for('student.dashboard') }}">Dashboard</a> / 
            <span>My Attendance</span>
        </div>
    </div>

    <!-- Attendance Grid -->
    <div class="attendance-grid dashboard-3col">
        <!-- Left Column -->
        <div class="left-column dashboard-col-left">
            <!-- Term Information Card -->
            <div class="card-custom mb-4">
                <div class="card-header-custom">Term Information</div>
                <div class="card-body-custom">
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Institution:</span>
                            <span class="info-value">{{term_info.institution_name}}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Term:</span>
                            <span class="info-value">{{term_info.semester_name}}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Student ID:</span>
                            <span class="info-value">{{term_info.student_id}}</span>
                        </div>
                        <div class="info-item highlight">
                            <span class="info-label">Minimum Requirement:</span>
                            <span class="info-value">{{term_info.cutoff}}%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View History Card -->
            <div class="card-custom">
                <div class="card-header-custom">Attendance History</div>
                <div class="card-body-custom">
                    <p class="history-description mb-3">View detailed attendance records for all your classes and terms.</p>
                    <a href="{{ url_for('student.attendance_history') }}" class="btn-custom btn-history">View Attendance History</a>
                </div>
            </div>
        </div>

        <!-- Middle Column - Monthly Statistics -->
        <div class="dashboard-col-middle">
        <div class="card-custom">
            <div class="card-header-custom">Monthly Attendance</div>
            <div class="card-body-custom">
                <div class="months-grid">
                    {% for report in monthly_report %}
                    <div class="month-item">
                        <div class="month-header">
                            <h3 class="month-title">{{report.month}}</h3>
                            {% if report.is_good %}
                            <span class="month-status good">On Track</span>
                            {% else %}
                            <span class="month-status warning">At Risk</span>
                            {% endif %}
                        </div>
                        <div class="chart-container">
                            <div class="chart" 
                                 data-present="{{report.present}}" 
                                 data-late="{{report.late}}" 
                                 data-excused="{{report.excused}}" 
                                 data-absent="{{report.absent}}" 
                                 data-total="{{report.total_classes}}"></div>
                        </div>
                        <div class="month-stats">
                            <div class="stat">
                                <span class="stat-label">Present:</span>
                                <span class="stat-value present">{{report.present}}</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Late:</span>
                                <span class="stat-value late">{{report.late}}</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Excused:</span>
                                <span class="stat-value excused">{{report.excused}}</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Absent:</span>
                                <span class="stat-value absent">{{report.absent}}</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Classes:</span>
                                <span class="stat-value">{{report.total_classes}}</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        </div>

        <!-- Right Column - Term Overview -->
        <div class="dashboard-col-right">
        <div class="card-custom">
            <div class="card-header-custom">Term Overview</div>
            <div class="card-body-custom">
                <!-- Overall Attendance -->
                <div class="term-overview">
                    <div class="overall-stats">
                        <div class="term-summary">
                            <!-- Pie chart -->
                            <div class="term-top">
                                <div class="term-pie">
                                    <div class="chart-container large">
                                        <div class="chart" id="overall-chart" 
                                             data-present="{{overview.present}}" 
                                             data-late="{{overview.late}}" 
                                             data-excused="{{overview.excused}}" 
                                             data-absent="{{overview.absent}}" 
                                             data-total="{{overview.marked}}"></div>
                                    </div>
                                </div>
                                <div class="term-main">
                                    <div class="term-title">Term Attendance</div>
                                    <div class="term-percent" id="overall-percentage">{{overview.present_percent|round(1)}}%</div>
                                </div>
                            </div>
                            <div class="term-status-row">
                                <div class="status-badge" id="status-badge">
                                    <span class="status-dot" id="status-dot"></span>
                                    <span class="status-text" id="status-text">Loading status...</span>
                                </div>
                            </div>
                            <div class="term-stats">
                                <div class="term-stat">
                                    <span>Present:</span>
                                    <strong id="present-count">{{overview.present}}</strong>
                                </div>
                                <div class="term-stat">
                                    <span>Absent:</span>
                                    <strong id="absent-count">{{overview.absent}}</strong>
                                </div>
                                <div class="term-stat">
                                    <span>Required:</span>
                                    <strong id="required-percent">≥{{term_info.cutoff}}%</strong>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Absent Classes -->
                    <div class="absent-section">
                        <div class="section-header">
                            <h3 class="section-title">Absent Classes</h3>
                            <a href="{{ url_for('student.appeal_management') }}" class="section-count">{{classes|length}} classes</a>
                        </div>

                        <div class="absent-list" id="absent-list-card">
                            {% for class in classes[:2] %}
                            <div class="absent-item">
                                <div class="absent-info">
                                    <div class="absent-class">
                                        <div class="flex-column justify-between">
                                            <strong>{{class.course_code}}</strong>
                                            <span class="month-status warning">{{class.status|capitalize}}</span>
                                        </div>
                                        <span>{{class.course_name}}</span>
                                    </div>
                                    <div class="absent-details">
                                        <div class="detail">
                                            <span class="detail-label">Date: </span>
                                            <span class="detail-value">{{class.start_date.strftime('%b %d, %Y • %H:%M-%H:%M')}}</span>
                                        </div>
                                        <div class="detail">
                                            <span class="detail-label">Venue:</span>
                                            <span class="detail-value">{{class.venue}}</span>
                                        </div>
                                        <div class="detail">
                                            <span class="detail-label">Lecturer:</span>
                                            <span class="detail-value">{{class.lecturer}}</span>
                                        </div>
                                    </div>
                                </div>
                                <a href="{{ url_for('student.appeal_form', attendance_record_id=class.attendance_id) }}" class="btn-custom btn-appeal">Appeal</a>
                            </div>
                            {% endfor %}
                        </div>

                        <div class="view-all">
                            <a href="{{ url_for('student.appeal_management') }}" class="view-all-link">View All Absent Records →</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Function to create circular progress chart
        function createDonutChart(container, present, late, excused, absent, total) {
            // Convert to numbers, handle undefined values
            present = parseFloat(present) || 0;
            late = parseFloat(late) || 0;
            excused = parseFloat(excused) || 0;
            absent = parseFloat(absent) || 0;
            total = parseFloat(total) || 0;
            
            //Empty chart when there is no data
            if (total === 0) {
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('viewBox', '0 0 100 100');
                svg.setAttribute('class', 'chart-svg');
                
                const bgCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                bgCircle.setAttribute('class', 'chart-bg');
                bgCircle.setAttribute('cx', '50');
                bgCircle.setAttribute('cy', '50');
                bgCircle.setAttribute('r', '40');
                svg.appendChild(bgCircle);
                
                container.innerHTML = '';
                container.appendChild(svg);
                return;
            }
            
            const radius = 40;
            const centerX = 50;
            const centerY = 50;
            const innerRadius = 28;
            
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', '0 0 100 100');
            svg.setAttribute('class', 'chart-svg');
            
            // Background circle
            const bgCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            bgCircle.setAttribute('class', 'chart-bg');
            bgCircle.setAttribute('cx', centerX.toString());
            bgCircle.setAttribute('cy', centerY.toString());
            bgCircle.setAttribute('r', radius.toString());
            svg.appendChild(bgCircle);
            
            // Helper function to create arc path for donut
            function createArc(startAngle, endAngle, innerR, outerR) {
                // Convert angles to radians, starting from 12 o'clock: -90 degrees
                const startRad = (startAngle - 90) * Math.PI / 180;
                const endRad = (endAngle - 90) * Math.PI / 180;
                
                // Calculate points on outer and inner circles
                const x1 = centerX + outerR * Math.cos(startRad);
                const y1 = centerY + outerR * Math.sin(startRad);
                const x2 = centerX + outerR * Math.cos(endRad);
                const y2 = centerY + outerR * Math.sin(endRad);
                
                const x3 = centerX + innerR * Math.cos(endRad);
                const y3 = centerY + innerR * Math.sin(endRad);
                const x4 = centerX + innerR * Math.cos(startRad);
                const y4 = centerY + innerR * Math.sin(startRad);
                
                const angleDiff = endAngle - startAngle;
                const largeArc = angleDiff > 180 ? 1 : 0;
                
                // Draw a donut 
                let path = `M ${x1} ${y1}`; // Start point outside
                path += ` A ${outerR} ${outerR} 0 ${largeArc} 1 ${x2} ${y2}`; // Outside curve
                path += ` L ${x3} ${y3}`; // Go to inside
                path += ` A ${innerR} ${innerR} 0 ${largeArc} 0 ${x4} ${y4}`; // Inside curve
                path += ` Z`;
                                
                return path;
            }
            
            // Calculation
            
            let currentAngle = 0;
            const totalMarked = present + late + excused + absent;
            
            // Present
            if (present > 0) {
                const presentAngle = (present / totalMarked) * 360;
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', createArc(currentAngle, currentAngle + presentAngle, innerRadius, radius));
                path.setAttribute('class', 'chart-segment chart-segment-present');
                svg.appendChild(path);
                currentAngle += presentAngle;
            }
            
            // Late
            if (late > 0) {
                const lateAngle = (late / totalMarked) * 360;
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', createArc(currentAngle, currentAngle + lateAngle, innerRadius, radius));
                path.setAttribute('class', 'chart-segment chart-segment-late');
                svg.appendChild(path);
                currentAngle += lateAngle;
            }
            
            // Excused
            if (excused > 0) {
                const excusedAngle = (excused / totalMarked) * 360;
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', createArc(currentAngle, currentAngle + excusedAngle, innerRadius, radius));
                path.setAttribute('class', 'chart-segment chart-segment-excused');
                svg.appendChild(path);
                currentAngle += excusedAngle;
            }
            
            // Absent
            if (absent > 0) {
                const absentAngle = (absent / totalMarked) * 360;
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', createArc(currentAngle, currentAngle + absentAngle, innerRadius, radius));
                path.setAttribute('class', 'chart-segment chart-segment-absent');
                svg.appendChild(path);
            }
            
            // Clear container and add SVG
            container.innerHTML = '';
            container.appendChild(svg);
        }
        
        // Initialize all monthly charts
        document.querySelectorAll('.chart').forEach(chart => {
            if (chart.id !== 'overall-chart') {
                const container = chart.closest('.chart-container');
                const present = chart.getAttribute('data-present');
                const late = chart.getAttribute('data-late');
                const excused = chart.getAttribute('data-excused');
                const absent = chart.getAttribute('data-absent');
                const total = chart.getAttribute('data-total');
                
                if (container) {
                    createDonutChart(container, present, late, excused, absent, total);
                }
            }
        });
        
        // Fetch attendance statistics from API
        function fetchAttendanceStatistics() {
            fetch("{{ url_for('student.attendance_statistics') }}")
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        updateDynamicContent(data.statistics);
                        updateOverallChart(data.statistics);
                    } else {
                        console.error('Error fetching statistics:', data.error);
                        updateFallbackContent();
                    }
                })
                .catch(error => {
                    console.error('Error fetching attendance statistics:', error);
                    updateFallbackContent();
                });
        }
        
        // Update dynamic content with fetched statistics
        function updateDynamicContent(stats) {
            // Update overall percentage
            const overallPercentage = document.getElementById('overall-percentage');
            if (overallPercentage) {
                overallPercentage.textContent = `${stats.overall_percent}%`;
            }
            
            // Update counts
            const presentCount = document.getElementById('present-count');
            if (presentCount) {
                presentCount.textContent = stats.present_count;
            }
            
            const absentCount = document.getElementById('absent-count');
            if (absentCount) {
                absentCount.textContent = stats.absent_count;
            }
            
            const requiredPercent = document.getElementById('required-percent');
            if (requiredPercent) {
                requiredPercent.textContent = `≥${stats.required_percent}%`;
            }
            
            // Update status badge
            updateStatusBadge(stats.overall_percent, stats.required_percent, stats.is_meeting_requirement);
        }
        
        // Update fallback content if API fails
        function updateFallbackContent() {
            const presentPercent = parseFloat("{{overview.present_percent|round(1)}}") || 0;
            const requiredPercent = parseInt("{{term_info.cutoff}}") || 90;
            
            updateStatusBadge(presentPercent, requiredPercent, presentPercent >= requiredPercent);
        }
        
        // Update overall chart with fetched data
        function updateOverallChart(stats) {
            const overallChart = document.getElementById('overall-chart');
            if (overallChart) {
                const overallChartContainer = overallChart.closest('.chart-container');
                // API returns present_count = present + late + excused, so keep only the real present count

                let present, late, excused, absent, total;
                
                if (stats.present_count !== undefined) {
                    // From API: present_count includes late + excused, so present = present_count - late_count - excused_count

                    late = stats.late_count || 0;
                    excused = stats.excused_count || 0;
                    present = (stats.present_count || 0) - late - excused;
                    absent = stats.absent_count || 0;
                    total = stats.marked_count || stats.total_count || 0;
                } else {
                    // Use template data if no real data is available
                    present = parseFloat(overallChart.getAttribute('data-present')) || 0;
                    late = parseFloat(overallChart.getAttribute('data-late')) || 0;
                    excused = parseFloat(overallChart.getAttribute('data-excused')) || 0;
                    absent = parseFloat(overallChart.getAttribute('data-absent')) || 0;
                    total = parseFloat(overallChart.getAttribute('data-total')) || 0;
                }
                
                if (overallChartContainer) {
                    createDonutChart(overallChartContainer, present, late, excused, absent, total);
                }
            }
        }
        
        // Update status badge based on attendance
        function updateStatusBadge(presentPercent, requiredPercent, isMeetingRequirement) {
            const statusBadge = document.getElementById('status-badge');
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            
            if (!statusBadge || !statusDot || !statusText) return;
            
            if (isMeetingRequirement) {
                statusBadge.style.backgroundColor = '#d1fae5';
                statusBadge.style.color = '#065f46';
                statusBadge.style.borderColor = '#10b981';
                statusDot.style.backgroundColor = '#059669';
                statusText.textContent = 'Meeting Requirement';
            } else {
                statusBadge.style.backgroundColor = '#fef2f2';
                statusBadge.style.color = '#dc2626';
                statusBadge.style.borderColor = '#dc2626';
                statusDot.style.backgroundColor = '#dc2626';
                statusText.textContent = `Below Requirement (≤${requiredPercent}%)`;
            }
        }
        
        // Appeal button functionality
        document.querySelectorAll('.btn-appeal').forEach(button => {
            button.addEventListener('click', function(e) {
                if (!this.getAttribute('href')) {
                    e.preventDefault();
                    const classInfo = this.closest('.absent-item').querySelector('.absent-class strong').textContent;
                    alert(`Starting appeal process for: ${classInfo}\n\nYou will be redirected to the appeal form.`);
                    
                    // Simulate navigation
                    setTimeout(() => {
                        window.location.href = "{{ url_for('student.appeal_management') }}";
                    }, 1000);
                }
            });
        });
        
        // View history button
        document.querySelector('.btn-history').addEventListener('click', function(e) {
            if (!this.getAttribute('href')) {
                e.preventDefault();
                alert('Loading attendance history...');
                
                // Simulate loading
                const originalText = this.textContent;
                this.textContent = 'Loading...';
                this.disabled = true;
                
                setTimeout(() => {
                    this.textContent = originalText;
                    this.disabled = false;
                    window.location.href = "{{ url_for('student.attendance_history') }}";
                }, 1500);
            }
        });
        
        // Initialize overall chart with template data
        const overallChart = document.getElementById('overall-chart');
        if (overallChart) {
            const overallContainer = overallChart.closest('.chart-container');
            // overview.present = present + late + excused, skeep only the real present count
            const presentCombined = parseFloat(overallChart.getAttribute('data-present')) || 0;
            const late = parseFloat(overallChart.getAttribute('data-late')) || 0;
            const excused = parseFloat(overallChart.getAttribute('data-excused')) || 0;
            const present = presentCombined - late - excused;
            const absent = parseFloat(overallChart.getAttribute('data-absent')) || 0;
            const total = parseFloat(overallChart.getAttribute('data-total')) || 0;
            
            if (overallContainer) {
                createDonutChart(overallContainer, present, late, excused, absent, total);
            }
        }
        
        // Fetch dynamic statistics
        fetchAttendanceStatistics();
    });
</script>
{% endblock %}