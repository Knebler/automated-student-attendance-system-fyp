{% extends "layouts/base.html" %}

{% block title %}Update Facial Data - AttendAI{% endblock %}

{% block content %}
<!-- CSRF Token Meta Tag -->
<meta name="csrf-token" content="{{ csrf_token() }}">

<style>
    .facial-data-page {
        max-width: 900px;
        margin: 0 auto;
    }

    .page-header {
        margin-bottom: 2rem;
        position: relative;
    }

    .page-header::after {
        content: "";
        position: absolute;
        bottom: -10px;
        left: 0;
        width: 100px;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-dark), #3b82f6);
        border-radius: 4px;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 0.5rem;
    }

    .page-subtitle {
        color: var(--text-light);
        font-size: 1rem;
    }

    /* Card Styles */
    .card-custom {
        background: white;
        border-radius: 14px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.06);
        overflow: hidden;
        margin-bottom: 1.5rem;
    }

    .card-header-custom {
        font-weight: 600;
        font-size: 1.1rem;
        padding: 1.25rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .card-body-custom {
        padding: 1.5rem;
    }

    /* Instructions */
    .instructions {
        background: #f0f9ff;
        border: 1px solid #bae6fd;
        border-radius: 10px;
        padding: 1rem 1.25rem;
        margin-bottom: 1.5rem;
    }

    .instructions-title {
        font-weight: 600;
        color: #0369a1;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .instructions-list {
        margin: 0;
        padding-left: 1.25rem;
        color: #0c4a6e;
    }

    .instructions-list li {
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    /* Camera Container */
    .camera-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1.5rem;
    }

    .video-wrapper {
        position: relative;
        width: 100%;
        max-width: 640px;
        background: #1e293b;
        border-radius: 12px;
        overflow: hidden;
        aspect-ratio: 4/3;
    }

    #videoElement {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(-1);
    }

    #canvasElement {
        display: none;
    }

    #overlayCanvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        transform: scaleX(-1);
        pointer-events: none;
    }

    .video-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
    }

    .face-guide {
        width: 250px;
        height: 300px;
        border: 3px dashed rgba(255, 255, 255, 0.5);
        border-radius: 50%;
        position: relative;
        animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
        0%, 100% {
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1);
        }
        50% {
            border-color: rgba(16, 185, 129, 0.8);
            transform: scale(1.02);
        }
    }

    .face-guide::after {
        content: "Position your face here";
        position: absolute;
        bottom: -40px;
        left: 50%;
        transform: translateX(-50%);
        color: white;
        font-size: 0.9rem;
        white-space: nowrap;
        background: rgba(0,0,0,0.5);
        padding: 0.25rem 0.75rem;
        border-radius: 4px;
    }

    .camera-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #94a3b8;
        gap: 1rem;
    }

    .camera-placeholder-icon {
        font-size: 4rem;
        opacity: 0.5;
    }

    .camera-placeholder-text {
        font-size: 1rem;
    }

    /* Camera Controls */
    .camera-controls {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        justify-content: center;
    }

    .btn-camera {
        padding: 0.875rem 2rem;
        border-radius: 50px;
        font-weight: 600;
        font-size: 1rem;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-start {
        background: linear-gradient(135deg, var(--primary-dark), #2563eb);
        color: white;
    }

    .btn-start:hover:not(:disabled) {
        background: linear-gradient(135deg, #2563eb, var(--primary-dark));
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .btn-capture {
        background: linear-gradient(135deg, #059669, #10b981);
        color: white;
    }

    .btn-capture:hover:not(:disabled) {
        background: linear-gradient(135deg, #047857, #059669);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
    }

    .btn-stop {
        background: #f1f5f9;
        color: #64748b;
        border: 1px solid var(--border-soft);
    }

    .btn-stop:hover:not(:disabled) {
        background: var(--border-soft);
    }

    .btn-save {
        background: linear-gradient(135deg, #059669, #10b981);
        color: white;
    }

    .btn-save:hover:not(:disabled) {
        background: linear-gradient(135deg, #047857, #059669);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
    }

    .btn-camera:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    /* Captured Images */
    .captured-section {
        width: 100%;
        max-width: 640px;
    }

    .captured-title {
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .captured-count {
        background: var(--primary-dark);
        color: white;
        padding: 0.2rem 0.6rem;
        border-radius: 12px;
        font-size: 0.8rem;
    }

    .captured-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 0.75rem;
    }

    .captured-image {
        aspect-ratio: 1;
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid var(--border-soft);
        position: relative;
    }

    .captured-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .captured-image .remove-btn {
        position: absolute;
        top: 4px;
        right: 4px;
        width: 20px;
        height: 20px;
        background: #dc2626;
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 0.7rem;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .captured-image:hover .remove-btn {
        opacity: 1;
    }

    .capture-placeholder {
        aspect-ratio: 1;
        border-radius: 8px;
        border: 2px dashed var(--border-soft);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #94a3b8;
        font-size: 1.5rem;
    }

    /* Progress */
    .progress-section {
        width: 100%;
        max-width: 640px;
    }

    .progress-bar-container {
        background: var(--border-soft);
        border-radius: 10px;
        height: 12px;
        overflow: hidden;
        margin-bottom: 0.5rem;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #059669, #10b981);
        border-radius: 10px;
        transition: width 0.3s ease;
    }

    .progress-text {
        text-align: center;
        color: var(--text-light);
        font-size: 0.9rem;
    }

    /* Status Messages */
    .status-message {
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .status-message.success {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #6ee7b7;
    }

    .status-message.error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fca5a5;
    }

    .status-message.info {
        background: #e0f2fe;
        color: #075985;
        border: 1px solid #7dd3fc;
    }

    .status-message.warning {
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #fcd34d;
    }

    /* Current Status */
    .current-status {
        background: #f8fafc;
        border-radius: 10px;
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .status-icon {
        font-size: 2.5rem;
    }

    .status-info h4 {
        margin: 0 0 0.25rem 0;
        font-size: 1rem;
        color: var(--text-dark);
    }

    .status-info p {
        margin: 0;
        font-size: 0.9rem;
        color: var(--text-light);
    }

    /* Back Button */
    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-light);
        text-decoration: none;
        font-size: 0.9rem;
        margin-bottom: 1.5rem;
        transition: color 0.2s;
    }

    .back-link:hover {
        color: var(--primary-dark);
    }

    /* Tips Section */
    .tips-section {
        background: #fefce8;
        border: 1px solid #fef08a;
        border-radius: 10px;
        padding: 1rem 1.25rem;
    }

    .tips-title {
        font-weight: 600;
        color: #854d0e;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .tips-list {
        margin: 0;
        padding-left: 1.25rem;
        color: #713f12;
    }

    .tips-list li {
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    /* Face Detection Status */
    .detection-status {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .detection-status.detected {
        background: rgba(5, 150, 105, 0.9);
    }

    .detection-status.not-detected {
        background: rgba(220, 38, 38, 0.9);
    }

    /* Loading Spinner */
    .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Capture Flash Effect */
    .capture-flash {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.1s ease;
    }

    .capture-flash.flash {
        opacity: 0.8;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .page-title {
            font-size: 1.5rem;
        }

        .captured-grid {
            grid-template-columns: repeat(4, 1fr);
        }

        .camera-controls {
            flex-direction: column;
            width: 100%;
        }

        .btn-camera {
            width: 100%;
            justify-content: center;
        }

        .face-guide {
            width: 180px;
            height: 220px;
        }
    }

    @media (max-width: 480px) {
        .captured-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }
</style>

<div class="facial-data-page">
    <!-- Back Link -->
    <a href="{{ url_for('student.profile') }}" class="back-link">
        ‚Üê Back to Profile
    </a>

    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">üì∏ Update Facial Data</h1>
        <p class="page-subtitle">Register or update your facial recognition data for automated attendance</p>
    </div>

    <!-- Status Message Area -->
    <div id="statusMessage" style="display: none;"></div>

    <!-- Current Status -->
    <div class="current-status">
        {% if facial_data_exists %}
        <div class="status-icon">‚úÖ</div>
        <div class="status-info">
            <h4>Facial Data Registered</h4>
            <p>Last updated: {{ last_updated | default('Unknown') }} ‚Ä¢ {{ sample_count }} samples stored. You can update your facial data below.</p>
        </div>
        {% else %}
        <div class="status-icon">‚ö†Ô∏è</div>
        <div class="status-info">
            <h4>Facial Data Not Registered</h4>
            <p>Please register your facial data to use automated attendance.</p>
        </div>
        {% endif %}
    </div>

    <!-- Main Card -->
    <div class="card-custom">
        <div class="card-header-custom">
            <span>üé•</span> Capture Facial Data
        </div>
        <div class="card-body-custom">
            <!-- Instructions -->
            <div class="instructions">
                <div class="instructions-title">
                    <span>üìã</span> Instructions
                </div>
                <ol class="instructions-list">
                    <li>Click <strong>"Start Camera"</strong> to enable your webcam</li>
                    <li>Wait for face detection models to load</li>
                    <li>Position your face within the oval guide until "Face Detected" appears</li>
                    <li>Click <strong>"Capture"</strong> to take photos (minimum 5 required)</li>
                    <li>Try different angles: front, slight left, slight right</li>
                    <li>Click <strong>"Save Facial Data"</strong> when you have enough photos</li>
                </ol>
            </div>

            <!-- Camera Section -->
            <div class="camera-container">
                <!-- Video Element -->
                <div class="video-wrapper" id="videoWrapper">
                    <div class="camera-placeholder" id="cameraPlaceholder">
                        <div class="camera-placeholder-icon">üì∑</div>
                        <div class="camera-placeholder-text">Click "Start Camera" to begin</div>
                    </div>
                    <video id="videoElement" autoplay playsinline style="display: none;"></video>
                    <canvas id="canvasElement"></canvas>
                    <canvas id="overlayCanvas"></canvas>
                    <div class="video-overlay" id="videoOverlay" style="display: none;">
                        <div class="face-guide"></div>
                    </div>
                    <div class="capture-flash" id="captureFlash"></div>
                    <div class="detection-status not-detected" id="detectionStatus" style="display: none;">
                        <span id="detectionIcon">‚ùå</span>
                        <span id="detectionText">No face detected</span>
                    </div>
                </div>

                <!-- Camera Controls -->
                <div class="camera-controls">
                    <button class="btn-camera btn-start" id="startBtn">
                        <span>üì∑</span> Start Camera
                    </button>
                    <button class="btn-camera btn-capture" id="captureBtn" disabled>
                        <span>üì∏</span> Capture
                    </button>
                    <button class="btn-camera btn-stop" id="stopBtn" disabled>
                        <span>‚èπÔ∏è</span> Stop Camera
                    </button>
                </div>

                <!-- Progress Bar -->
                <div class="progress-section" id="progressSection" style="display: none;">
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>
                    <div class="progress-text" id="progressText">0 / 5 photos captured (minimum 5 required)</div>
                </div>

                <!-- Captured Images -->
                <div class="captured-section" id="capturedSection" style="display: none;">
                    <div class="captured-title">
                        <span>üñºÔ∏è</span> Captured Photos
                        <span class="captured-count" id="capturedCount">0</span>
                    </div>
                    <div class="captured-grid" id="capturedGrid">
                        <!-- Captured images will be added here -->
                    </div>
                </div>

                <!-- Save Button -->
                <button class="btn-camera btn-save" id="saveBtn" disabled style="display: none;">
                    <span>üíæ</span> Save Facial Data
                </button>
            </div>
        </div>
    </div>

    <!-- Tips Section -->
    <div class="tips-section">
        <div class="tips-title">
            <span>üí°</span> Tips for Best Results
        </div>
        <ul class="tips-list">
            <li>Ensure good lighting - avoid backlighting or harsh shadows</li>
            <li>Remove glasses, hats, or anything covering your face</li>
            <li>Keep a neutral expression</li>
            <li>Take photos from slightly different angles for better recognition</li>
            <li>Make sure your entire face is visible in the frame</li>
            <li>Wait for the green "Face Detected" indicator before capturing</li>
        </ul>
    </div>
</div>

<!-- Load face-api.js from CDN -->
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

<script>
const FacialCapture = (function() {
    'use strict';
    
    // Configuration
    const config = {
        minPhotos: 5,
        maxPhotos: 10,
        apiUrl: "/student/api/facial-data/save",
        csrfToken: document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
                   document.querySelector('input[name="csrf_token"]')?.value || 
                   '{{ csrf_token() }}'
    };
    
    // State
    let state = {
        stream: null,
        capturedImages: [],
        capturedEncodings: [],
        isCapturing: false,
        modelsLoaded: false,
        faceDetected: false,
        currentDetection: null
    };
    
    // DOM Elements
    const elements = {
        video: document.getElementById('videoElement'),
        canvas: document.getElementById('canvasElement'),
        overlayCanvas: document.getElementById('overlayCanvas'),
        placeholder: document.getElementById('cameraPlaceholder'),
        overlay: document.getElementById('videoOverlay'),
        captureFlash: document.getElementById('captureFlash'),
        detectionStatus: document.getElementById('detectionStatus'),
        detectionIcon: document.getElementById('detectionIcon'),
        detectionText: document.getElementById('detectionText'),
        startBtn: document.getElementById('startBtn'),
        captureBtn: document.getElementById('captureBtn'),
        stopBtn: document.getElementById('stopBtn'),
        saveBtn: document.getElementById('saveBtn'),
        progressSection: document.getElementById('progressSection'),
        progressBar: document.getElementById('progressBar'),
        progressText: document.getElementById('progressText'),
        capturedSection: document.getElementById('capturedSection'),
        capturedGrid: document.getElementById('capturedGrid'),
        capturedCount: document.getElementById('capturedCount'),
        statusMessage: document.getElementById('statusMessage')
    };
    
    // Show status message
    function showStatus(message, type = 'info') {
        elements.statusMessage.className = `status-message ${type}`;
        elements.statusMessage.innerHTML = `<span>${getStatusIcon(type)}</span><span>${message}</span>`;
        elements.statusMessage.style.display = 'flex';
        
        if (type === 'success' || type === 'info') {
            setTimeout(() => {
                elements.statusMessage.style.display = 'none';
            }, 5000);
        }
    }
    
    function getStatusIcon(type) {
        const icons = { success: '‚úÖ', error: '‚ùå', info: '‚ÑπÔ∏è', warning: '‚ö†Ô∏è' };
        return icons[type] || '‚ÑπÔ∏è';
    }

    // Load face-api.js models
    async function loadModels() {
        showStatus('Loading face detection models... Please wait.', 'info');
        
        // Try multiple CDN sources
        const MODEL_URLS = [
            'https://justadudewhohacks.github.io/face-api.js/models',
            'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@master/weights',
            'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights'
        ];
        
        for (const MODEL_URL of MODEL_URLS) {
            try {
                console.log('Trying to load models from:', MODEL_URL);
                
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                console.log('TinyFaceDetector loaded');
                
                await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
                console.log('FaceLandmark68Net loaded');
                
                await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
                console.log('FaceRecognitionNet loaded');
                
                state.modelsLoaded = true;
                showStatus('Face detection models loaded successfully!', 'success');
                return true;
            } catch (error) {
                console.warn('Failed to load from:', MODEL_URL, error);
                continue;
            }
        }
        
        console.error('All model sources failed');
        showStatus('Failed to load face detection models. Please check your internet connection and refresh.', 'error');
        return false;
    }
    
    // Start camera
    async function startCamera() {
        // Load models first if not loaded
        if (!state.modelsLoaded) {
            const loaded = await loadModels();
            if (!loaded) return;
        }

        // Check if getUserMedia is supported
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            console.error('getUserMedia is not supported in this browser');
            showStatus('Camera access is not supported. Please use HTTPS or a modern browser.', 'error');
            return;
        }

        try {
            state.stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    width: { ideal: 640 },
                    height: { ideal: 480 },
                    facingMode: 'user'
                }
            });
            
            elements.video.srcObject = state.stream;
            elements.video.style.display = 'block';
            elements.placeholder.style.display = 'none';
            elements.overlay.style.display = 'flex';
            elements.detectionStatus.style.display = 'flex';
            
            // Set canvas dimensions when video loads
            elements.video.onloadedmetadata = () => {
                elements.overlayCanvas.width = elements.video.videoWidth;
                elements.overlayCanvas.height = elements.video.videoHeight;
                elements.canvas.width = elements.video.videoWidth;
                elements.canvas.height = elements.video.videoHeight;
                console.log('Video dimensions:', elements.video.videoWidth, 'x', elements.video.videoHeight);
            };
            
            // Wait for video to actually start playing before detecting
            elements.video.onplaying = () => {
                console.log('Video is playing, starting face detection...');
                // Start face detection loop
                state.isCapturing = true;
                detectFace();
            };
            
            elements.startBtn.disabled = true;
            elements.captureBtn.disabled = true; // Will enable when face detected
            elements.stopBtn.disabled = false;
            
            elements.progressSection.style.display = 'block';
            elements.capturedSection.style.display = 'block';
            
            showStatus('Camera started. Position your face in the guide.', 'info');
            
        } catch (error) {
            console.error('Camera error:', error);
            showStatus('Could not access camera. Please check permissions.', 'error');
        }
    }
    
    // Face detection loop
    async function detectFace() {
        if (!state.isCapturing) return;

        const ctx = elements.overlayCanvas.getContext('2d');
        
        try {
            // Use more sensitive detection options
            const options = new faceapi.TinyFaceDetectorOptions({ 
                inputSize: 416,      // Larger input for better detection
                scoreThreshold: 0.3  // Lower threshold for easier detection
            });
            
            const detection = await faceapi.detectSingleFace(elements.video, options)
                .withFaceLandmarks()
                .withFaceDescriptor();

            ctx.clearRect(0, 0, elements.overlayCanvas.width, elements.overlayCanvas.height);

            if (detection) {
                state.faceDetected = true;
                state.currentDetection = detection;
                
                // Draw face detection box
                const box = detection.detection.box;
                ctx.strokeStyle = '#10b981';
                ctx.lineWidth = 3;
                ctx.strokeRect(box.x, box.y, box.width, box.height);

                // Draw landmarks
                ctx.fillStyle = '#10b981';
                detection.landmarks.positions.forEach(point => {
                    ctx.beginPath();
                    ctx.arc(point.x, point.y, 2, 0, 2 * Math.PI);
                    ctx.fill();
                });

                // Update detection status
                elements.detectionStatus.className = 'detection-status detected';
                elements.detectionIcon.textContent = '‚úÖ';
                elements.detectionText.textContent = 'Face Detected - Ready to capture';
                elements.captureBtn.disabled = false;
            } else {
                state.faceDetected = false;
                state.currentDetection = null;
                
                // Update detection status
                elements.detectionStatus.className = 'detection-status not-detected';
                elements.detectionIcon.textContent = '‚ùå';
                elements.detectionText.textContent = 'No face detected - Position your face';
                elements.captureBtn.disabled = true;
            }
        } catch (error) {
            console.error('Detection error:', error);
            // Don't show error to user for every frame, just log it
        }

        // Continue detection loop
        if (state.isCapturing) {
            requestAnimationFrame(detectFace);
        }
    }
    
    // Stop camera
    function stopCamera() {
        state.isCapturing = false;
        
        if (state.stream) {
            state.stream.getTracks().forEach(track => track.stop());
            state.stream = null;
        }
        
        elements.video.style.display = 'none';
        elements.placeholder.style.display = 'flex';
        elements.overlay.style.display = 'none';
        elements.detectionStatus.style.display = 'none';
        
        // Clear overlay canvas
        const ctx = elements.overlayCanvas.getContext('2d');
        ctx.clearRect(0, 0, elements.overlayCanvas.width, elements.overlayCanvas.height);
        
        elements.startBtn.disabled = false;
        elements.captureBtn.disabled = true;
        elements.stopBtn.disabled = true;
        
        showStatus('Camera stopped.', 'info');
    }
    
    // Capture photo
    function capture() {
        if (!state.faceDetected || !state.currentDetection) {
            showStatus('Please position your face in the frame.', 'warning');
            return;
        }
        
        if (state.capturedImages.length >= config.maxPhotos) {
            showStatus(`Maximum ${config.maxPhotos} photos allowed.`, 'warning');
            return;
        }
        
        const video = elements.video;
        const canvas = elements.canvas;
        const ctx = canvas.getContext('2d');
        
        // Draw mirrored image
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(video, 0, 0);
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        
        // Get base64 image for display
        const imageData = canvas.toDataURL('image/jpeg', 0.9);
        state.capturedImages.push(imageData);
        
        // Store the face encoding (128-dimensional vector)
        const encoding = Array.from(state.currentDetection.descriptor);
        state.capturedEncodings.push(encoding);
        
        // Flash effect
        elements.captureFlash.classList.add('flash');
        setTimeout(() => {
            elements.captureFlash.classList.remove('flash');
        }, 100);
        
        // Update UI
        updateCapturedGrid();
        updateProgress();
        
        showStatus(`Photo ${state.capturedImages.length} captured!`, 'success');
    }
    
    // Update captured images grid
    function updateCapturedGrid() {
        elements.capturedGrid.innerHTML = '';
        
        state.capturedImages.forEach((img, index) => {
            const div = document.createElement('div');
            div.className = 'captured-image';
            div.innerHTML = `
                <img src="${img}" alt="Capture ${index + 1}">
                <button class="remove-btn" onclick="FacialCapture.removeImage(${index})">√ó</button>
            `;
            elements.capturedGrid.appendChild(div);
        });
        
        // Add placeholders for remaining slots
        const remaining = config.minPhotos - state.capturedImages.length;
        for (let i = 0; i < Math.max(0, remaining); i++) {
            const placeholder = document.createElement('div');
            placeholder.className = 'capture-placeholder';
            placeholder.textContent = '+';
            elements.capturedGrid.appendChild(placeholder);
        }
        
        elements.capturedCount.textContent = state.capturedImages.length;
    }
    
    // Update progress bar
    function updateProgress() {
        const progress = Math.min((state.capturedImages.length / config.minPhotos) * 100, 100);
        elements.progressBar.style.width = progress + '%';
        
        if (state.capturedImages.length < config.minPhotos) {
            elements.progressText.textContent = `${state.capturedImages.length} / ${config.minPhotos} photos captured (minimum ${config.minPhotos} required)`;
            elements.saveBtn.disabled = true;
            elements.saveBtn.style.display = 'none';
        } else {
            elements.progressText.textContent = `${state.capturedImages.length} photos captured ‚úì Ready to save!`;
            elements.saveBtn.disabled = false;
            elements.saveBtn.style.display = 'flex';
        }
    }
    
    // Remove image
    function removeImage(index) {
        state.capturedImages.splice(index, 1);
        state.capturedEncodings.splice(index, 1);
        updateCapturedGrid();
        updateProgress();
    }
    
    // Save facial data
    async function save() {
        if (state.capturedEncodings.length < config.minPhotos) {
            showStatus(`Please capture at least ${config.minPhotos} photos.`, 'warning');
            return;
        }
        
        elements.saveBtn.disabled = true;
        elements.saveBtn.innerHTML = '<span class="spinner"></span> Saving...';
        
        try {
            console.log('Sending photos:', state.capturedImages.length);
            console.log('Photo data type:', typeof state.capturedImages[0]);
            
            const response = await fetch(config.apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'X-CSRFToken': config.csrfToken
                },
                body: JSON.stringify({
                    photos: state.capturedImages,  // Send actual photos for OpenCV processing
                    sample_count: state.capturedImages.length
                })
            });
            
            console.log('Response status:', response.status);
            
            // Check if response is JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                console.error('Non-JSON response:', text.substring(0, 500));
                throw new Error('Server returned an invalid response. Please try again.');
            }
            
            const data = await response.json();
            console.log('Response data:', data);
            
            if (data.success) {
                showStatus('Facial data saved successfully! Redirecting...', 'success');
                stopCamera();
                
                setTimeout(() => {
                    window.location.href = "{{ url_for('student.profile') }}";
                }, 2000);
            } else {
                showStatus(data.error || 'Failed to save facial data.', 'error');
                elements.saveBtn.disabled = false;
                elements.saveBtn.innerHTML = '<span>üíæ</span> Save Facial Data';
            }
        } catch (error) {
            console.error('Save error:', error);
            showStatus(error.message || 'An error occurred. Please try again.', 'error');
            elements.saveBtn.disabled = false;
            elements.saveBtn.innerHTML = '<span>üíæ</span> Save Facial Data';
        }
    }
    
    // Initialize
    function init() {
        updateCapturedGrid();
        updateProgress();
        
        // Bind event listeners
        elements.startBtn.addEventListener('click', startCamera);
        elements.captureBtn.addEventListener('click', capture);
        elements.stopBtn.addEventListener('click', stopCamera);
        elements.saveBtn.addEventListener('click', save);
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (state.stream) {
                state.stream.getTracks().forEach(track => track.stop());
            }
        });
    }
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
    
    // Public API
    return {
        startCamera,
        stopCamera,
        capture,
        removeImage,
        save
    };
})();
</script>
{% endblock %}